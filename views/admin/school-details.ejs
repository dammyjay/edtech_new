<%- include('../partials/adminHeader', { title: school.name }) %>

<style>
.nav-tabs {
  display: flex;
  justify-content: start;
  gap: 10px;
  margin: 20px 0;
  border-bottom: 2px solid #ddd;
  flex-wrap: wrap;
}

.tab-btn {
  background: #f0f0f0;
  border: none;
  padding: 10px 20px;
  cursor: pointer;
  font-weight: 600;
  border-radius: 6px 6px 0 0;
  transition: background 0.3s, color 0.3s;
  color: black;
}

.tab-btn:hover {
  background: #e1e1e1;
}

.tab-btn.active {
  background: #3498db;
  color: white;
  border-bottom: 2px solid white;
}
</style>


<section class="section">
    <h2><%= school.name %> - Details</h2>
    <p><strong>Email:</strong> <%= school.email %></p>
    <p><strong>Phone:</strong> <%= school.phone %></p>
    <p><strong>Address:</strong> <%= school.address %></p>

    <hr>
    <div class="stats-summary">
      <p>üë®‚Äçüéì Total Students: <%= school.totals.total_students %></p>
      <p>üë©‚Äçüè´ Total Teachers: <%= school.totals.total_teachers %></p>
      <p>üìå Total Instructors: <%= school.totals.total_instructors %></p>
    </div>

    <a href="/admin/schools/<%= school.id %>/download-progress" class="btn-edit">
      üìÑ Download School Summary PDF
    </a>

    <div style="margin-top: 20px;">
      <a
        href="/admin/schools/<%= school.id %>/download-login-cards"
        class="btn-download"
        target="_blank"
      >
        üì• Download Student Login Cards (PDF)
      </a>
    </div>


    <hr>

    <h3>Classrooms</h3>
    <ul>
    <% if (school.classrooms.length > 0) { %>
        <% school.classrooms.forEach(classroom => { %>
        <li><%= classroom.name %></li>
        <% }) %>
    <% } else { %>
        <p>No classrooms available.</p>
    <% } %>
    </ul>

    <hr>
    
</section>

<section class="section">
  <h3>üéì Courses Assigned to This School</h3>

  <% if (school.courses.length > 0) { %>
    <table class="user-table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Level</th>
        </tr>
      </thead>
      <tbody>
        <% school.courses.forEach(course => { %>
          <tr>
            <td><%= course.title %></td>
            <td><%= course.level || '-' %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } else { %>
    <p>No courses assigned yet.</p>
  <% } %>
</section>


<!-- Navigation Tabs -->
<div class="nav-tabs">
  <button class="tab-btn active" onclick="openTab('teachers-section', this)">üë©‚Äçüè´ Teachers</button>
  <button class="tab-btn" onclick="openTab('instructors-section', this)">üßë‚Äçüè´ Instructors</button>
  <button class="tab-btn" onclick="openTab('students-section', this)">üéì Students</button>
  <button class="tab-btn" onclick="openTab('classrooms-section', this)">üè´ Classrooms</button>
  <button class="tab-btn" onclick="openTab('course-assignment-section', this)">üìò Assign Courses</button>

</div>



<!-- teachers section -->
<div id="teachers-section" style="display:none;">
  <button onclick="openUserForm('teacher')">‚ûï Add Teacher</button>

  <!-- üîΩ Classroom filter -->
  <label><strong>Filter by Classroom:</strong></label>
  <select id="teacherClassFilter" onchange="filterUsers('teachersTable', 'teacherClassFilter', 'teacherSearch')" style="margin:10px 0; padding:5px;">
    <option value="">All</option>
    <% school.classrooms.forEach(c => { %>
      <option value="<%= c.name %>"><%= c.name %></option>
    <% }) %>
  </select>

  <!-- üîé Search box -->
  <input 
    type="text" 
    id="teacherSearch" 
    placeholder="Search teacher by name or email..." 
    onkeyup="filterUsers('teachersTable', 'teacherClassFilter', 'teacherSearch')" 
    style="margin-left:10px; padding:5px;"
  />

  <div class="table-responsive">
    <table id="teachersTable" class="user-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Classroom</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
      <% if (school.teachers.length > 0) { %>
          <% school.teachers.forEach(teacher => { %>
            <tr>
              <td><%= teacher.full_name %></td>
              <td><%= teacher.email %></td>
              <td><%= teacher.classroom_name || '‚Äî' %></td>
              <!-- <td>
                <button class="btn-view" onclick='openUserModal(<%- JSON.stringify(teacher) %>)'>üëÅÔ∏è View</button>
              </td> -->
              <td>
                <button class="btn-view" onclick='openUserModal(<%- JSON.stringify(teacher) %>)'>üëÅÔ∏è View</button>
                <button class="btn-assign" onclick="openAssignModal('<%= teacher.id %>', 'teacher')">üìå Assign</button>
              </td>

            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="4" style="text-align:center;">No teachers yet</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>
<hr>

<!-- instructors section -->
<div id="instructors-section" style="display:none;">
  <div class="table-responsive">
    <table id="instructorsTable" class="user-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Classrooms</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (school.instructors.length > 0) { %>
          <% school.instructors.forEach(inst => { %>
            <tr>
              <td><%= inst.full_name %></td>
              <td><%= inst.email %></td>
              <td><%= inst.classrooms %></td>
              <td>
                <button class="btn-assign" onclick="openAssignModal('<%= inst.id %>', 'instructor')">üìå Assign</button>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="4" style="text-align:center;">No instructors yet</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>


<!-- students section  -->
<div id="students-section" style="display:none;">
  <button onclick="openUserForm('student')">‚ûï Add Student</button>

  <!-- üîΩ Classroom filter -->
  <label><strong>Filter by Classroom:</strong></label>
  <select id="studentClassFilter" onchange="filterUsers('studentsTable', 'studentClassFilter', 'studentSearch')" style="margin:10px 0; padding:5px;">
    <option value="">All</option>
    <% school.classrooms.forEach(c => { %>
      <option value="<%= c.name %>"><%= c.name %></option>
    <% }) %>
  </select>

  <!-- üîé Search box -->
  <input 
    type="text" 
    id="studentSearch" 
    placeholder="Search student by name or email..." 
    onkeyup="filterUsers('studentsTable', 'studentClassFilter', 'studentSearch')" 
    style="margin-left:10px; padding:5px;"
  />

  

  <!-- tabe for students -->
  <div class="table-responsive">
    <table id="studentsTable" class="user-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Classroom</th>
          <th>Actions</th>
          <th>Progress</th>
        </tr>
      </thead>
      <tbody>
        <% if (school.students.length > 0) { %>
          <% school.students.forEach(student => { %>
            <tr>
              <td><%= student.full_name %></td>
              <td><%= student.email %></td>
              <td><%= student.classroom_name || '‚Äî' %></td>
              <td>
                <button class="btn-view" onclick='openUserModal(<%- JSON.stringify(student) %>)'>üëÅÔ∏è View</button>
                <button class="btn-assign" 
                  onclick="openAssignModal('<%= student.id %>', 'student', '<%= student.classroom_id || '' %>')">
                  üìå Assign
                </button>

                <button class="btn-delete" onclick="deleteUser('<%= student.id %>')">üóëÔ∏è Delete</button>
              </td>
              <td>
                <a href="/admin/students/<%= student.id %>/progress?from=admin"
                  class="btn-edit"
                  style="background:green; color:#fff; padding:5px 8px; border-radius:4px; text-decoration:none;">
                  Progress
                </a>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="4" style="text-align:center;">No students yet</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>
<hr>

<!-- classrooms section  -->
<div id="classrooms-section" style="display:none;">
  <button class="btn-edit" onclick="openModal('createClassroomModal')" style="margin-bottom:15px;">
    ‚ûï Create Classroom
  </button>

  <div class="table-responsive">
    <table class="user-table" style="width:95%; margin-top:20px;">
      <thead>
        <tr>
          <th>Classroom Name</th>
          <th>No. of Students</th>
          <th>No. of Teachers</th>
          <th>No. of Instructors</th>
          <th>Course</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (school.classrooms.length > 0) { %>
          <% school.classrooms.forEach(c => { %>
            <tr>
              <td><%= c.name %></td>
              <td id="student-count-<%= c.id %>"><%= c.student_count %></td>
              <td id="teacher-count-<%= c.id %>"><%= c.teacher_count %></td>
              <td id="instructor-count-<%= c.id %>"><%= c.instructor_count %></td>
              <td>
                <div id="classroom-courses-<%= c.id %>" data-classroom-id="<%= c.id %>">
                  <em>Loading courses...</em>
                </div>
              </td>
              <td>
                <button onclick="toggleStudents('<%= c.id %>')">üëÅ View / Manage</button>
                <button onclick="updateClassroom('<%= c.id %>', { name: prompt('New name?') })">‚úè Edit</button>
                <button onclick="deleteClassroom('<%= c.id %>')">üóë Delete</button>
              </td>
            </tr>


            <!-- Add under each classroom row -->
            <tr id="assign-multi-row-<%= c.id %>">
              <td colspan="5">
                <form onsubmit="assignUsers(event, '<%= c.id %>', 'student')">
                  <label><strong>Assign Multiple Students to <%= c.name %>:</strong></label>
                  <select id="studentMultiSelect-<%= c.id %>" multiple size="5" style="width:100%; margin-top:8px;">
                    <% school.students
                      .filter(s => !s.classroom_id) // only unassigned students
                      .forEach(s => { %>
                        <option value="<%= s.id %>"><%= s.full_name %> (<%= s.email %>)</option>
                    <% }) %>
                  </select>
                  <button type="submit" style="margin-top:10px; background:#3498db; color:#fff; border:none; padding:8px 12px; border-radius:5px;">
                    Assign Selected Students
                  </button>
                </form>
              </td>
            </tr>


            <!-- Hidden expandable row -->
            <tr id="students-row-<%= c.id %>" style="display:none;">
              <td colspan="5">
                <div id="students-container-<%= c.id %>">
                  <em>Loading...</em>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="5" style="text-align:center;">No classrooms yet</td></tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- assigning course section -->
<div id="course-assignment-section" style="display:none;">
  <h3>üìò Assign Courses to Classrooms</h3>

  <form id="assignCourseForm" onsubmit="assignCourseToClassroom(event)">
    <label><strong>Select Classroom:</strong></label>
    <select id="classroomSelect" required style="width:100%; padding:8px; margin:10px 0;">
      <option value="">-- Choose Classroom --</option>
      <% school.classrooms.forEach(c => { %>
        <option value="<%= c.id %>"><%= c.name %></option>
      <% }) %>
    </select>

    <label><strong>Select Course(s):</strong></label>
    <select id="courseSelect" multiple required size="6" style="width:100%; padding:8px; margin:10px 0;">
      <% school.courses.forEach(course => { %>
        <option value="<%= course.id %>"><%= course.title %> - Level <%= course.level || '‚Äî' %></option>
      <% }) %>
    </select>

    <button type="submit" style="background:#3498db; color:#fff; border:none; padding:10px 15px; border-radius:5px;">
      Assign Selected Courses
    </button>
  </form>

  <hr>

  <h4>üìã Classroom Course Assignments</h4>
  <div id="classroomCourseList">
    <p><em>Select a classroom to view assigned courses.</em></p>
  </div>
</div>



<!-- Create Classroom Modal -->
<div id="createClassroomModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('createClassroomModal')">&times;</span>
    <h2>‚ûï Create Classroom</h2>

    <form id="createClassroomForm">
      <input type="hidden" name="school_id" value="<%= school.id %>">

      <label for="name">Classroom Name</label>
      <input type="text" name="name" id="name" required>

      <label for="teacher_id">Assign Teachers (optional)</label>
      <select name="teacher_id" id="teacher_id" multiple size="5">
        <% school.teachers.forEach(t => { %>
          <option value="<%= t.id %>"><%= t.full_name %> (<%= t.email %>)</option>
        <% }) %>
      </select>
      <button type="submit">Create</button>
    </form>


  </div>
</div>

<!-- Edit Classroom Modal -->
<div id="editClassroomModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('editClassroomModal')">&times;</span>
    <h2>‚úè Edit Classroom</h2>
    
    <form id="editClassroomForm" method="POST">
      <input type="text" name="id" id="edit_classroom_id">

      <label for="edit_name">Classroom Name</label>
      <input type="text" name="name" id="edit_name" required>

      <label for="edit_teacher_ids">Assign Teachers</label>
      <select name="teacher_ids" id="edit_teacher_ids" multiple size="5">
        <% school.teachers.forEach(t => { %>
          <option value="<%= t.id %>"><%= t.full_name %> (<%= t.email %>)</option>
        <% }) %>
      </select>

      <small>Hold <b>Ctrl</b> (Windows) or <b>Cmd</b> (Mac) to select multiple</small>

      <button type="submit" class="btn-edit">Update</button>
    </form>
  </div>
</div>



<!-- User Modal -->
<div id="userModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; text-align: left;">
    <span onclick="closeUserModal()" class="close" style="float:right;cursor:pointer;">&times;</span>
    <h2>User Details</h2>
    <img id="modalProfilePic" src="" alt="Profile" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;"><br><br>
    
    <p><strong>Full Name:</strong> <span id="modalFullName"></span></p>
    <p><strong>Email:</strong> <span id="modalEmail"></span></p>
    <p><strong>Phone:</strong> <span id="modalPhone"></span></p>
    <p><strong>Date of Birth:</strong> <span id="modalDOB"></span></p>
    <p><strong>Gender:</strong> <span id="modalGender"></span></p>
    <p><strong>Role:</strong> <span id="modalRole"></span></p>
    <p><strong>Classroom:</strong> <span id="modalClassroom"></span></p>
    <p><strong>walletBalance:</strong> ‚Ç¶<span id="modalWalletBalance"></span></p>
    <p><strong>Date Registered:</strong> <span id="modalDate"></span></p>

    <hr>
    <!-- üîë Reset Password Form -->
    <h3>Reset Password</h3>
    <form id="resetPasswordForm">
      <input type="hidden" id="resetUserId">
      <div class="container">
        <input type="password" id="newPassword" placeholder="Enter new password" required />
      </div>
      <button type="submit" style="margin-top:10px; background:#f39c12; color:white; padding:8px 15px; border:none; border-radius:5px;">Reset Password</button>
    </form>
  </div>
</div>

<!-- Assign Modal -->
<div id="assignModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width: 400px; margin: auto; background: #fff; padding: 20px; border-radius: 8px;">
    <span onclick="closeAssignModal()" class="close" style="float:right;cursor:pointer;">&times;</span>
    <h3 id="assignTitle">Assign User</h3>
    
    <form id="assignForm">
      <input type="hidden" id="assignUserId">
      <input type="hidden" id="assignRole">
      
      <label>Select Classroom:</label>
      <select id="assignClassroom" required style="width:100%; padding:8px; margin-top:10px;">
        <option value="">-- Select Classroom --</option>
        <% school.classrooms.forEach(c => { %>
          <option value="<%= c.id %>"><%= c.name %></option>
        <% }) %>
      </select>

      <button type="submit" style="margin-top:15px; background:#3498db; color:white; padding:8px 15px; border:none; border-radius:5px;">Save</button>
    </form>
  </div>
</div>


<!-- User Form Modal -->
<div id="userFormModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width: 600px; margin:auto; background:#fff; padding:20px; border-radius:8px;">
    <span onclick="closeUserForm()" class="close" style="float:right;cursor:pointer;">&times;</span>
    <h2 id="userFormTitle">Add User</h2>

    <form id="user-form" enctype="multipart/form-data">
      <input type="hidden" name="schoolId" value="<%= school.id %>">
      <input type="hidden" name="role" id="userRole">

      <div class="container">
        <input type="text" name="username" id="userFullName" placeholder="Full name" required />
      </div>

      <!-- Email -->
      <div class="container" id="emailContainer">
        <input type="text" name="email" id="userEmail" placeholder="Email" />
      </div>

      <!-- Phone -->
      <div class="container" id="phoneContainer">
        <input type="number" name="phone" id="userPhone" placeholder="Phone" required />
      </div>

      <div class="container">
        <input type="date" name="dob" placeholder="Date of birth" required />
      </div>
      <div class="container">
        <select name="gender" required>
          <option>Male</option>
          <option>Female</option>
          <option>Not Specified</option>
        </select>
      </div>
      <div class="container">
        <input type="password" name="password" placeholder="Password" />
      </div>
      <div class="container">
        <label>Profile Picture:</label>
        <input type="file" name="profile_picture" accept="image/*" />
      </div>

      <button type="submit">Save</button>
    </form>
  </div>
</div>

<!-- script for nav tab  -->
<script>
function openTab(sectionId, btn) {
  // Hide all sections
  const sections = ['teachers-section', 'instructors-section', 'students-section', 'classrooms-section', 'course-assignment-section'];
  sections.forEach(id => {
    document.getElementById(id).style.display = 'none';
  });

  // Show selected
  document.getElementById(sectionId).style.display = 'block';
  document.getElementById(sectionId).style.width = '100%';

  // Update active tab
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}
</script>

<!-- close button script -->
<script>
  function closeUserModal() {
    const modal = document.getElementById("userModal");
    if (modal) {
      modal.style.display = "none";
    }
  }
</script>


<!-- script for user form modal open and close -->
<script>
  document.getElementById("user-form").onsubmit = async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const schoolId = "<%= school.id %>";   // inject schoolId from EJS

  const res = await fetch(`/admin/schools/${schoolId}/users`, {
    method: "POST",
    body: formData
  });

  if (res.ok) {
    alert("Saved successfully!");
    location.reload();
  } else {
    alert("Failed: " + (await res.text()));
  }
};

  function openUserForm(role, user = null) {
    document.getElementById("userRole").value = role;
    document.getElementById("userFormTitle").innerText = user ? `Edit ${role}` : `Add ${role}`;
    document.getElementById("user-form").reset();

    const emailContainer = document.getElementById("emailContainer");
    const phoneContainer = document.getElementById("phoneContainer");
    const emailInput = document.getElementById("userEmail");
    const phoneInput = document.getElementById("userPhone");
    const fullNameInput = document.getElementById("userFullName");

    // Reset defaults
    emailContainer.style.display = "block";
    phoneContainer.style.display = "block";
    emailInput.readOnly = false;
    emailInput.required = true;
    phoneInput.required = true;

    // If role is student, customize fields
    if (role === "student") {
      emailContainer.style.display = "block";
      emailInput.readOnly = true;
      emailInput.required = true;

      phoneContainer.style.display = "none";
      phoneInput.required = false;

      // Auto-generate email from fullname + school
      fullNameInput.addEventListener("blur", () => {
        const fullName = fullNameInput.value.trim().replace(/\s+/g, "").toLowerCase();
        const schoolFirstWord = "<%= school.name.split(' ')[0].toLowerCase() %>";
        if (fullName) {
          emailInput.value = `${fullName}@${schoolFirstWord}school.com`;
        }
      });
    }

    // Prefill if editing
    if (user) {
      document.querySelector("input[name='username']").value = user.full_name;
      document.querySelector("input[name='email']").value = user.email;
      document.querySelector("input[name='phone']").value = user.phone;
      document.querySelector("input[name='dob']").value = user.dob;
      document.querySelector("select[name='gender']").value = user.gender;
    }

    document.getElementById("userFormModal").style.display = "block";
  }

  function closeUserForm() {
    document.getElementById("userFormModal").style.display = "none";
  }
</script>

<script>
  async function deleteUser(userId) {
    if (!confirm("Are you sure?")) return;
    const schoolId = "<%= school.id %>";
    const res = await fetch(`/admin/schools/${schoolId}/users/${userId}`, { method: "DELETE" });
    if (res.ok) {
      alert("Deleted successfully!");
      location.reload();
    } else {
      alert("Delete failed");
    }
  }

  

  async function toggleStudents(classroomId) {
    const row = document.getElementById(`students-row-${classroomId}`);
    const container = document.getElementById(`students-container-${classroomId}`);

    if (row.style.display === "none") {
      row.style.display = "table-row";

      if (!container.dataset.loaded) {
        try {
          const res = await fetch(`/admin/classrooms/${classroomId}/students`);
          const students = await res.json();

          if (students.length === 0) {
            container.innerHTML = "<p>No students in this classroom.</p>";
          } else {
            let html = `
              <div class="table-responsive">
                <table class="user-table" style="width:100%; margin-top:10px; background:#f9f9f9;">
                  <thead>
                    <tr>
                      <th>Full Name</th>
                      <th>Email</th>
                      <th>Phone</th>
                      <th>Gender</th>
                      <th>DOB</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            students.forEach(stu => {
              html += `
                <tr>
                  <td>${stu.fullname}</td>
                  <td>${stu.email || "‚Äî"}</td>
                  <td>${stu.phone || "‚Äî"}</td>
                  <td>${stu.gender || "‚Äî"}</td>
                  <td>${stu.dob ? new Date(stu.dob).toLocaleDateString() : "‚Äî"}</td>
                </tr>
              `;
            });
            html += "</tbody></table></div>";
            container.innerHTML = html;
          }

          container.dataset.loaded = "true";
        } catch (err) {
          container.innerHTML = "<p style='color:red;'>Failed to load students.</p>";
        }
      }
    } else {
      row.style.display = "none";
    }
  }
</script>

<!-- script for getting classroom students -->
<script>
  async function toggleStudents(classroomId) {
    const row = document.getElementById(`students-row-${classroomId}`);
    const container = document.getElementById(`students-container-${classroomId}`);

    if (row.style.display === "none") {
      row.style.display = "table-row";

      // If not loaded yet, fetch via AJAX
      if (!container.dataset.loaded) {
        try {
          const res = await fetch(`/admin/classrooms/${classroomId}/students`);
          const students = await res.json();

          if (students.length === 0) {
            container.innerHTML = "<p>No students in this classroom.</p>";
          } else {
            let html = `
              <div class="table-responsive">
                <table class="user-table" style="width:100%; margin-top:10px; background:#f9f9f9;">
                  <thead>
                    <tr>
                      <th>Full Name</th>
                      <th>Email</th>
                      <th>Phone</th>
                      <th>Gender</th>
                      <th>DOB</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            students.forEach(stu => {
              html += `
                <tr>
                  <td>${stu.fullname}</td>
                  <td>${stu.email || "‚Äî"}</td>
                  <td>${stu.phone || "‚Äî"}</td>
                  <td>${stu.gender || "‚Äî"}</td>
                  <td>${stu.dob ? new Date(stu.dob).toLocaleDateString() : "‚Äî"}</td>
                </tr>
              `;
            });
            html += "</tbody></table></div>";
            container.innerHTML = html;
          }
          container.dataset.loaded = "true"; // avoid re-fetch
        } catch (err) {
          container.innerHTML = "<p style='color:red;'>Failed to load students.</p>";
        }
      }
    } else {
      row.style.display = "none"; // collapse
    }
  }
</script>

<!-- script for toggle section  -->
<script>
  function toggleSection(id) {
    const el = document.getElementById(id);
    if (el.style.display === "none" || el.style.display === "") {
      el.style.display = "block";
      el.style.width =  "100%";
    } else {
      el.style.display = "none";
    }
  }
</script>


<!-- script for fitler table -->
<script>
function filterUsers(tableId, selectId, searchId) {
  const filterClass = document.getElementById(selectId).value.toLowerCase();
  const searchText = document.getElementById(searchId).value.toLowerCase();
  const table = document.getElementById(tableId);
  const trs = table.getElementsByTagName("tr");

  for (let i = 1; i < trs.length; i++) { // skip header
    const tds = trs[i].getElementsByTagName("td");
    if (tds.length > 0) {
      const nameText = tds[0].innerText.toLowerCase();
      const emailText = tds[1].innerText.toLowerCase();
      const classText = tds[2].innerText.toLowerCase();

      const matchClass = (filterClass === "" || classText === filterClass);
      const matchSearch = (nameText.includes(searchText) || emailText.includes(searchText));

      trs[i].style.display = (matchClass && matchSearch) ? "" : "none";
    }
  }
}
</script>

<!-- script for user modal -->
<script>
  function openUserModal(user) {
    document.getElementById("modalProfilePic").src = user.profile_picture || "/profile.webp";
    document.getElementById("modalFullName").textContent = user.full_name || "‚Äî";
    document.getElementById("modalEmail").textContent = user.email || "‚Äî";
    document.getElementById("modalPhone").textContent = user.phone || "‚Äî";
    document.getElementById("modalDOB").textContent = user.dob ? new Date(user.dob).toLocaleDateString() : "‚Äî";
    document.getElementById("modalGender").textContent = user.gender || "‚Äî";
    document.getElementById("modalRole").textContent = user.role_in_school || user.role || "‚Äî";
    document.getElementById("modalClassroom").textContent = user.classroom_name || "‚Äî";
    document.getElementById("modalWalletBalance").textContent = user.wallet_balance || 0;
    document.getElementById("modalDate").textContent = user.created_at ? new Date(user.created_at).toDateString() : "‚Äî";

    // üîë set userId for reset password
    document.getElementById("resetUserId").value = user.id;

    document.getElementById("userModal").style.display = "block";
  }

  // Handle reset password submit
  document.getElementById("resetPasswordForm").onsubmit = async (e) => {
    e.preventDefault();
    const userId = document.getElementById("resetUserId").value;
    const newPassword = document.getElementById("newPassword").value.trim();
    const schoolId = "<%= school.id %>";

    if (!newPassword) {
      return alert("Password cannot be empty");
    }

    const res = await fetch(`/admin/schools/${schoolId}/users/${userId}/reset-password`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ newPassword })
    });

    if (res.ok) {
      alert("Password reset successfully ‚úÖ");
      document.getElementById("newPassword").value = "";
      closeUserModal();
    } else {
      alert("Failed: " + (await res.text()));
    }
  };
</script>

<!-- close user modal when clicking outside -->
<script>
  window.onclick = function (event) {
    const userModal = document.getElementById("userModal");
    const formModal = document.getElementById("userFormModal");
    const resetModal = document.getElementById("resetPasswordModal"); // new reset modal

    // Close User Modal
    if (userModal && event.target === userModal) {
      closeUserModal();
    }

    // Close User Form Modal
    if (formModal && event.target === formModal) {
      closeUserForm();
    }

    // Close Reset Password Modal
    if (resetModal && event.target === resetModal) {
      closeResetPasswordModal();
    }
  };
</script>

<!-- script for assigning students to classroom -->

  <script>
    // Assign multiple students to a classroom in ONE request
    async function assignUsers(e, classroomId, role) {
      e.preventDefault();
      const select = document.getElementById(`${role}MultiSelect-${classroomId}`);
      const selected = Array.from(select.options)
        .filter(o => o.selected)
        .map(o => parseInt(o.value, 10));

      if (selected.length === 0) {
        return alert(`Please select at least one ${role}.`);
      }

      try {
        const res = await fetch(`/admin/classrooms/${classroomId}/assign`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_ids: selected, role })
        });

        const data = await res.json();
        if (data.success) {
          alert(`‚úÖ ${selected.length} ${role}(s) assigned successfully!`);

          // üîÑ Refresh list inline
          if (role === "student") {
            await refreshStudents(classroomId);
          }

          // üîÑ Update the count cell
          const countCell = document.getElementById(`${role}-count-${classroomId}`);
          if (countCell) {
            let currentCount = parseInt(countCell.textContent || "0", 10);
            countCell.textContent = currentCount + selected.length;
          }

          // üîÑ Rebuild dropdown with unassigned users
          select.innerHTML = "";
          if (data.unassigned && data.unassigned.length > 0) {
            data.unassigned.forEach(u => {
              const opt = document.createElement("option");
              opt.value = u.id;
              opt.textContent = `${u.full_name || u.fullname} (${u.email})`;
              select.appendChild(opt);
            });
          } else {
            const opt = document.createElement("option");
            opt.disabled = true;
            opt.textContent = `No unassigned ${role}s available`;
            select.appendChild(opt);
          }
        } else {
          alert("‚ùå Failed: " + data.message);
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Request failed.");
      }
    }


    // Refresh only this classroom's student list
    async function refreshStudents(classroomId) {
      const container = document.getElementById(`students-container-${classroomId}`);
      try {
        const res = await fetch(`/admin/classrooms/${classroomId}/students`);
        const students = await res.json();

        if (students.length === 0) {
          container.innerHTML = "<p>No students in this classroom.</p>";
        } else {
          let html = `
            <div class="table-responsive">
              <table class="user-table" style="width:100%; margin-top:10px; background:#f9f9f9;">
                <thead>
                  <tr>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Gender</th>
                    <th>DOB</th>
                  </tr>
                </thead>
                <tbody>
          `;
          students.forEach(stu => {
            html += `
              <tr>
                <td>${stu.fullname}</td>
                <td>${stu.email || "‚Äî"}</td>
                <td>${stu.phone || "‚Äî"}</td>
                <td>${stu.gender || "‚Äî"}</td>
                <td>${stu.dob ? new Date(stu.dob).toLocaleDateString() : "‚Äî"}</td>
              </tr>
            `;
          });
          html += "</tbody></table></div>";
          container.innerHTML = html;
        }
      } catch (err) {
        container.innerHTML = "<p style='color:red;'>Failed to refresh students.</p>";
      }
    }
  

    // function openAssignModal(userId, role, currentClassroomId = null) {
    //   document.getElementById("assignUserId").value = userId;
    //   document.getElementById("assignRole").value = role;
    //   document.getElementById("assignTitle").innerText = `Assign ${role} to a Classroom`;

    //   const select = document.getElementById("assignClassroom");
    //   if (currentClassroomId) {
    //     select.value = currentClassroomId; // auto-select their existing class
    //   } else {
    //     select.value = ""; // default empty
    //   }

    //   document.getElementById("assignModal").style.display = "block";
    // }

    function openAssignModal(userId, role, currentClassroomId = null) {
  document.getElementById("assignUserId").value = userId;
  document.getElementById("assignRole").value = role;
  document.getElementById("assignTitle").innerText = `Assign ${role} to Classroom`;

  const select = document.getElementById("assignClassroom");

  if (role === "instructor") {
    select.setAttribute("multiple", "multiple"); // allow many classes
    select.value = "";
  } else {
    select.removeAttribute("multiple"); // only one class
    if (currentClassroomId) {
      select.value = currentClassroomId;
    } else {
      select.value = "";
    }
  }

  document.getElementById("assignModal").style.display = "block";
}


    function closeAssignModal() {
      document.getElementById("assignModal").style.display = "none";
    }

    document.getElementById("assignForm").onsubmit = async (e) => {
      e.preventDefault();
      const userId = document.getElementById("assignUserId").value;
      const role = document.getElementById("assignRole").value;
      const classroomId = document.getElementById("assignClassroom").value;
      const schoolId = "<%= school.id %>";

      if (!classroomId) return alert("Please select a classroom");

      const res = await fetch(`/admin/classrooms/${classroomId}/assign`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_ids: [parseInt(userId)], role })
      });

      const data = await res.json();
      if (data.success) {
        alert(`‚úÖ ${role} assigned successfully!`);
        closeAssignModal();
        location.reload(); // reload to reflect classroom assignment
      } else {
        alert("‚ùå Failed: " + data.message);
      }
    };
  
  </script>

<!-- script for creating & editing classroom -->
<script>
  function openModal(id) {
    document.getElementById(id).style.display = "block";
  }

  function closeModal(id) {
    document.getElementById(id).style.display = "none";
  }

  // üîπ Open edit modal and prefill
  function openEditClassroom(id, name, teacherIds) {
    document.getElementById("edit_classroom_id").value = id;
    document.getElementById("edit_name").value = name;

    const teacherSelect = document.getElementById("edit_teacher_ids");
    Array.from(teacherSelect.options).forEach(opt => {
      opt.selected = teacherIds.includes(parseInt(opt.value));
    });

    openModal('editClassroomModal');
  }

  // ‚úÖ Create Classroom
  document.getElementById("createClassroomForm").onsubmit = async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const payload = Object.fromEntries(formData.entries());

    // Handle multi-select teachers
    if (formData.getAll("teacher_id").length > 0) {
      payload.teacher_id = formData.getAll("teacher_id");
    }

    const res = await fetch("/admin/classrooms/new", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.success) {
      alert("‚úÖ Classroom created!");
      const classroom = data.classroom;

      // üîÑ Add new row to classrooms table
      const tbody = document.querySelector("table.user-table tbody");
      const tr = document.createElement("tr");
      tr.setAttribute("id", `classroom-row-${classroom.id}`);
      tr.innerHTML = `
        <td>${classroom.name}</td>
        <td id="student-count-${classroom.id}">${classroom.student_count}</td>
        <td id="teacher-count-${classroom.id}">${classroom.teacher_count}</td>
        <td id="instructor-count-${classroom.id}">${classroom.instructor_count}</td>
        <td>
          <button class="btn-edit" onclick="toggleStudents('${classroom.id}')">üëÅ View Students</button>
          <button class="btn-edit" onclick="openEditClassroom('${classroom.id}','${classroom.name}',[])">‚úè Edit</button>
        </td>
      `;
      tbody.appendChild(tr);

      // üîÑ Update dropdowns (teacher filter, student filter, assign modal)
      addClassroomToDropdowns(classroom);

      closeModal("createClassroomModal");
      e.target.reset();
    } else {
      alert("‚ùå " + data.message);
    }
  };

  // ‚úÖ Edit Classroom
  document.getElementById("editClassroomForm").onsubmit = async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const payload = Object.fromEntries(formData.entries());
    const classroomId = payload.id;

    if (formData.getAll("teacher_ids").length > 0) {
      payload.teacher_ids = formData.getAll("teacher_ids");
    }

    const res = await fetch(`/admin/classrooms/${classroomId}/edit`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (data.success) {
      alert("‚úè Classroom updated!");
      const classroom = data.classroom;

      // üîÑ Update the table row
      const row = document.getElementById(`classroom-row-${classroom.id}`);
      if (row) {
        row.innerHTML = `
          <td>${classroom.name}</td>
          <td id="student-count-${classroom.id}">${classroom.student_count}</td>
          <td id="teacher-count-${classroom.id}">${classroom.teacher_count}</td>
          <td id="instructor-count-${classroom.id}">${classroom.instructor_count}</td>
          <td>
            <button class="btn-edit" onclick="toggleStudents('${classroom.id}')">üëÅ View Students</button>
            <button class="btn-edit" onclick="openEditClassroom('${classroom.id}','${classroom.name}',[])">‚úè Edit</button>
          </td>
        `;
      }

      // üîÑ Update classroom name in dropdowns
      updateClassroomInDropdowns(classroom);

      closeModal("editClassroomModal");
    } else {
      alert("‚ùå " + data.message);
    }
  };

  // üîπ Helper: Add classroom to dropdowns
  function addClassroomToDropdowns(classroom) {
    const dropdownIds = ["teacherClassFilter", "studentClassFilter", "assignClassroom"];
    dropdownIds.forEach(id => {
      const select = document.getElementById(id);
      if (select) {
        const opt = document.createElement("option");
        opt.value = classroom.id;
        opt.textContent = classroom.name;
        select.appendChild(opt);
      }
    });
  }

  // üîπ Helper: Update classroom name in dropdowns
  function updateClassroomInDropdowns(classroom) {
    const dropdownIds = ["teacherClassFilter", "studentClassFilter", "assignClassroom"];
    dropdownIds.forEach(id => {
      const select = document.getElementById(id);
      if (select) {
        const opt = select.querySelector(`option[value="${classroom.id}"]`);
        if (opt) opt.textContent = classroom.name;
      }
    });
  }

  // ‚úèÔ∏è Edit Classroom
async function updateClassroom(id) {
  const name = prompt("Enter new classroom name:");
  if (!name) return alert("Classroom name is required.");

  try {
    const res = await fetch(`/admin/classrooms/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name }),
    });

    if (res.ok) {
      alert("‚úÖ Classroom updated successfully!");
      location.reload();
    } else {
      const data = await res.json();
      alert("‚ùå " + data.message);
    }
  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Network or server error.");
  }
}

// üóëÔ∏è Delete Classroom
async function deleteClassroom(id) {
  if (!confirm("Are you sure you want to delete this classroom?")) return;

  try {
    const res = await fetch(`/admin/classrooms/${id}`, {
      method: "DELETE",
    });

    if (res.ok) {
      alert("üóë Classroom deleted successfully!");
      location.reload();
    } else {
      const data = await res.json();
      alert("‚ùå " + data.message);
    }
  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Error deleting classroom.");
  }
}


</script>


<!-- script for assigning courses to classroom -->
<script>
async function assignCourseToClassroom(e) {
  e.preventDefault();

  const classroomId = document.getElementById("classroomSelect").value;
  const selectedCourses = Array.from(document.getElementById("courseSelect").selectedOptions)
    .map(opt => opt.value);

  if (!classroomId || selectedCourses.length === 0) {
    return alert("‚ö†Ô∏è Please select a classroom and at least one course.");
  }

  try {
    const res = await fetch(`/admin/classrooms/${classroomId}/assign-courses`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ course_ids: selectedCourses })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "Failed to assign courses.");

    alert("‚úÖ Courses assigned successfully!");
    await refreshAllClassroomCourses(); // refresh table courses

  } catch (err) {
    console.error("Assignment error:", err);
    alert("‚ùå " + (err.message || "Request failed. Try again."));
  }
}


// üß© Load courses for a single classroom
async function loadClassroomCoursesById(classroomId) {
  const container = document.getElementById(`classroom-courses-${classroomId}`);
  if (!container) return;

  container.innerHTML = "<em>Loading...</em>";

  try {
    const res = await fetch(`/admin/classrooms/${classroomId}/courses`);
    const data = await res.json();

    if (!res.ok) throw new Error("Failed to load courses.");

    if (!data || data.length === 0) {
      container.innerHTML = "<em>No courses assigned yet.</em>";
      return;
    }

    container.innerHTML = data.map(c => `<span class="course-tag">${c.title}</span>`).join(", ");

  } catch (err) {
    console.error("Error loading courses:", err);
    container.innerHTML = "<span style='color:red;'>‚ùå Error loading</span>";
  }
}


// üîÅ Refresh all classrooms at once (used on page load or after assigning)
async function refreshAllClassroomCourses() {
  const all = document.querySelectorAll("[id^='classroom-courses-']");
  for (const el of all) {
    const id = el.dataset.classroomId;
    if (id) await loadClassroomCoursesById(id);
  }
}


// üéØ When page loads, populate all classroom course cells
document.addEventListener("DOMContentLoaded", () => {
  refreshAllClassroomCourses();
});
</script>



