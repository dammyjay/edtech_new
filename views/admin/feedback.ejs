<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Feedback Dashboard</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/style2.css">
  <link rel="stylesheet" href="/css/style3.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.2/wordcloud2.min.js"></script>

  <style>
    .stat-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 160px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align:center;
    }
    .stat-box h3 { margin-bottom: 10px; font-size: 16px; color: #444; }
    .stat-box p { font-size: 22px; font-weight: bold; }
    .btn {
      display:inline-block;
      padding:10px 15px;
      background:#007bff;
      color:white;
      border-radius:6px;
      text-decoration:none;
      margin-right:8px;
    }
    .modal {
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      padding-top:60px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      z-index:9999; /* ✅ makes it appear on top */
    }

    .modal-content {
      background:white;
      padding:20px;
      border-radius:8px;
      width:90%;
      max-width:600px;
      margin:auto;
    }

    .filter {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        width: auto;
        margin-bottom:12px;
      }

    .publish-btn {
      background: #28a745;
      color: white;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    .publish-btn.unpublish {
      background: #6c757d;
    }

    .delete-btn {
      background: #d9534f;
      color: white;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
    }


    @media screen {
      .filter {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        width: auto;
        margin-bottom:12px;
      }
    }
  </style>
</head>

<body>

  <%- include('../partials/adminHeader', { info: info, currentPage: 'feedback' }) %>

  <h1 style="margin-top:20px;">Feedback Dashboard</h1>

  <!-- EXPORT BUTTONS -->
  <div style="margin:20px 0;">
    <a href="/admin/feedback/export/pdf" class="btn">Export PDF</a>
    <a href="/admin/feedback/export/excel" class="btn">Export Excel</a>
    <a href="/admin/feedback/export/csv" class="btn">Export CSV</a>
  </div>

  <!-- SUMMARY CARDS -->
<div style="display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
  <div class="stat-box">
    <h3>Total Feedback</h3>
    <p><%= feedback.length %></p>
  </div>

  <div class="stat-box">
    <h3>Average Rating</h3>
    <p><%= (feedback.reduce((s,f)=>s+(f.rating||0),0)/feedback.length).toFixed(1) %> ⭐</p>
  </div>

  <div class="stat-box">
    <h3>Students</h3>
    <p><%= feedback.filter(f=>f.user_type==='student').length %></p>
  </div>

  <div class="stat-box">
    <h3>Teachers</h3>
    <p><%= feedback.filter(f=>f.user_type==='teacher').length %></p>
  </div>

  <div class="stat-box">
    <h3>Parents</h3>
    <p><%= feedback.filter(f=>f.user_type==='parent').length %></p>
  </div>

  <div class="stat-box">
    <h3>School Owners</h3>
    <p><%= feedback.filter(f=>f.user_type==='school_owner').length %></p>
  </div>

  <div class="stat-box">
    <h3>Organizations</h3>
    <p><%= feedback.filter(f=>f.user_type==='organization').length %></p>
  </div>
</div>

  <!-- FILTERS -->
  <div class="filter" >
    <select id="filterType">
      <option value="">All Users</option>
      <option value="parent">Parent</option>
      <option value="student">Student</option>
      <option value="teacher">Teacher</option>
      <option value="school_owner">School Owner</option>
      <option value="organization">Organization</option>
    </select>

    <select id="filterRating">
      <option value="">Any Rating</option>
      <option value="5">5</option><option value="4">4</option>
      <option value="3">3</option><option value="2">2</option><option value="1">1</option>
    </select>

    <select id="filterPublished">
      <option value="">Both</option>
      <option value="true">Published</option>
      <option value="false">Unpublished</option>
    </select>

    <input id="filterSearch" placeholder="Search feedback..." style="flex:1;">

    <button id="applyFilters">Apply</button>
  </div>

  <!-- WORD CLOUD -->
  <h3>Keyword Cloud</h3>
  <canvas id="wordCloudCanvas" width="500" height="230"></canvas>

  <!-- TABLE -->
  <div id="feedbackTableWrap" class="table-responsive" style="margin-top:20px;"></div>

  <!-- PAGINATION -->
  <div id="pagination" style="margin-top:20px;"></div>

  <!-- MODAL -->
  <div id="feedbackModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span onclick="closeFeedbackModal()" style="float:right; cursor:pointer; font-size:20px;">&times;</span>
      <h2>Feedback Details</h2>
      <p><strong>User Type:</strong> <span id="fbType"></span></p>
      <p><strong>Name:</strong> <span id="fbName"></span></p>
      <p><strong>Email:</strong> <span id="fbEmail"></span></p>
      <p><strong>Rating:</strong> <span id="fbRating"></span></p>
      <p><strong>Sentiment:</strong> <span id="fbSentiment"></span></p>
      <p><strong>Message:</strong></p>
      <div id="fbMessage" style="padding:10px; background:#f3f3f3; border-radius:6px;"></div>
      <p><strong>Published:</strong></p> <span id="fbPublished"></span>
    </div>
  </div>

<script>
const fetchJSON = (url) => fetch(url).then(r=>r.json());
let currentPage = 1, perPage = 15;

async function loadFeedback() {
  const qs = new URLSearchParams({
    page: currentPage,
    perPage,
    user_type: filterType.value || "",
    rating: filterRating.value || "",
    published: filterPublished.value || "",
    search: filterSearch.value || ""
  });

  const data = await fetchJSON(`/admin/feedback/api?${qs}`);
  renderTable(data.rows);
  renderPagination(data.total, data.page);
  renderWordCloud(data.rows);
}

// ===== TABLE RENDERING =====
// function renderTable(rows){
//   let html = `
//     <table class="user-table">
//       <thead>
//         <tr>
//           <th>Type</th><th>Name</th><th>Email</th><th>Rating</th>
//           <th>Sentiment</th><th>Date</th><th>Action</th>
//         </tr>
//       </thead>
//       <tbody>
//   `;
//   rows.forEach(r=>{
//     html += `
//       <tr>
//         <td>${r.user_type}</td>
//         <td>${r.name}</td>
//         <td>${r.email || ""}</td>
//         <td>${r.rating || "—"}</td>
//         <td>${r.sentiment_label || "—"}</td>
//         <td>${new Date(r.created_at).toLocaleString()}</td>
//         <td><button class="view-btn" data-id="${r.id}">View</button></td>
//       </tr>`;
//   });

//   html += "</tbody></table>";
//   feedbackTableWrap.innerHTML = html;

//   document.querySelectorAll(".view-btn").forEach(btn => {
//   btn.addEventListener("click", () => {
//     openFeedbackModal(btn.dataset.id);
//   });
// });

// window.addEventListener('click', (e)=>{
//   if(e.target === feedbackModal){
//     closeFeedbackModal();
//   }
// });

// }

function renderTable(rows){
  let html = `
    <table class="user-table">
      <thead>
        <tr>
          <th>Type</th><th>Name</th><th>Email</th><th>Rating</th>
          <th>Sentiment</th><th>Feedback</><th>Published</><th>Date</th><th>Action</th>
        </tr>
      </thead>
      <tbody>
  `;

  rows.forEach(r=>{
    html += `
      <tr>
        <td>${r.user_type}</td>
        <td>${r.name}</td>
        <td>${r.email || ""}</td>
        <td>${r.rating || "—"}</td>
        <td>${r.sentiment_label || "—"}</td>
        <td>${r.message}</td>
        <td>${r.is_published}</td>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>
          <button class="view-btn" data-id="${r.id}">View</button>

          <button class="publish-btn" data-id="${r.id}" data-status="${r.is_published}">
            ${r.is_published ? "Unpublish" : "Publish"}
          </button>

          <button class="delete-btn" data-id="${r.id}" style="background:#d9534f;color:white;">
            Delete
          </button>
        </td>

      </tr>`;
  });

  html += "</tbody></table>";
  feedbackTableWrap.innerHTML = html;

  // ADD EVENT LISTENER HERE
  document.querySelectorAll(".view-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      openFeedbackModal(btn.dataset.id);
    });
  });

  document.querySelectorAll(".publish-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;
    const newStatus = btn.dataset.status === "true" ? false : true;

    await fetch(`/admin/feedback/publish/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: newStatus })
    });

    loadFeedback(); // refresh table
  });
});

document.querySelectorAll(".delete-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    if (!confirm("Are you sure you want to delete this feedback?")) return;

    await fetch(`/admin/feedback/delete/${btn.dataset.id}`, {
      method: "DELETE"
    });

    loadFeedback(); // refresh table
  });
});
  window.addEventListener('click', (e)=>{
    if(e.target === feedbackModal){
      closeFeedbackModal();
    }
  });
}


// ===== PAGINATION =====
function renderPagination(total, page){
  const pages = Math.ceil(total / perPage);
  let html = "";
  for(let i=1;i<=pages;i++){
    html += `<button onclick="goToPage(${i})" ${i===page?"disabled":""}>${i}</button>`;
  }
  pagination.innerHTML = html;
}
function goToPage(n){ currentPage=n; loadFeedback(); }

// ===== WORD CLOUD =====
function renderWordCloud(rows){
  const words = {};

  rows.forEach(r=>{
    if(r.keywords){
      let k = r.keywords;
      if(typeof k === "string") k = JSON.parse(k);
      k.forEach(w => words[w.word] = (words[w.word]||0) + w.count);
    }
  });

  const list = Object.entries(words).map(([w,c]) => [w,c]);

  if(list.length){
    WordCloud(document.getElementById("wordCloudCanvas"), {
      list,
      gridSize: 10,
      weightFactor: 12,
      backgroundColor: "white"
    });
  }
}

// ===== MODAL VIEW =====
async function openFeedbackModal(id){
  const row = await fetchJSON(`/admin/feedback/detail/${id}`);

  fbType.textContent = row.user_type;
  fbName.textContent = row.name;
  fbEmail.textContent = row.email || "—";
  fbRating.textContent = row.rating || "—";
  fbSentiment.textContent = `${row.sentiment_label} (${row.sentiment_score})`;
  fbMessage.textContent = row.message;
  fbPublished.textContent = row.is_published ? "Yes" : "No";

  feedbackModal.style.display = "block";
}
function closeFeedbackModal(){
  feedbackModal.style.display = "none";
}

// ===== FILTER BUTTON =====
applyFilters.addEventListener("click", ()=>{currentPage=1; loadFeedback();});

loadFeedback();
</script>

</body>
</html>
