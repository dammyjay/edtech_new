<%- include('../partials/adminHeader', { title: 'Schools' }) %>

<h2>All Registered Schools</h2>
<div class="table-responsive">
  <table class="user-table" style="width:100%; margin-top:20px;">
    <thead>
      <tr>
        <th>School Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>No. of Students</th>
        <th>No. of Teachers</th>
        <th>No of Classrooms</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% schools.forEach(school => { %>
        <tr>
          <td><%= school.name %></td>
          <td><%= school.email %></td>
          <td><%= school.phone %></td>
          <td><%= school.student_count %></td>
          <td><%= school.teacher_count %></td>
          <td><%= school.classroom_count %></td>
          <td>
            <a href="/admin/schools/<%= school.id %>" class="btn-view">üëÅÔ∏è View</a>
            <button class="btn-edit" 
                    onclick="openEditSchoolModal('<%= school.id %>', '<%= school.name %>', '<%= school.email || '' %>', '<%= school.phone || '' %>', '<%= school.logo_url || '' %>')">
              ‚úèÔ∏è Edit
            </button>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<!-- üü¶ Modal -->
<div id="editSchoolModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditSchoolModal()">&times;</span>
    <h2 id="modalTitle">Edit School Information</h2>

    <form id="editSchoolForm" enctype="multipart/form-data">
      <input type="hidden" name="id" id="schoolId">

      <label>School Name</label>
      <input type="text" id="schoolName" readonly style="background:#f8f8f8; border:1px solid #ddd;">

      <label>Email</label>
      <input type="email" name="email" id="schoolEmail" placeholder="Enter school email">

      <label>Phone</label>
      <input type="text" name="phone" id="schoolPhone" placeholder="Enter phone number">

      <label>Address</label>
      <input type="text" name="address" id="schoolAddress" placeholder="Enter address">

      <label>Logo</label>
      <div class="logo-preview">
        <img id="logoPreview" 
             src="/Images/default-logo.png"
             alt="School Logo"
             width="120"
             height="120"
             style="border-radius: 10px; border: 1px solid #ccc; object-fit: contain;">
      </div>
      <input type="file" name="logo" id="logoInput" accept="image/*">

      <button type="submit" class="btn-save">üíæ Update</button>
    </form>
  </div>
</div>

<script>
// üü¶ Open modal & populate fields
function openEditSchoolModal(id, name, email, phone, logo) {
  document.getElementById("editSchoolModal").style.display = "flex";
  document.getElementById("schoolId").value = id;
  document.getElementById("schoolName").value = name;
  document.getElementById("schoolEmail").value = email;
  document.getElementById("schoolPhone").value = phone;
  ocument.getElementById("schoolAddress").value = address;
  document.getElementById("logoPreview").src = logo_url || '/images/profile.jpg';
}

function closeEditSchoolModal() {
  document.getElementById("editSchoolModal").style.display = "none";
}

// üñº Preview uploaded logo
document.getElementById("logoInput").addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = () => {
      document.getElementById("logoPreview").src = reader.result;
    };
    reader.readAsDataURL(file);
  }
});

// üíæ Handle update form submission
document.getElementById("editSchoolForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);

  const res = await fetch("/admin/schools/update", {
    method: "POST",
    body: formData
  });

  const data = await res.json();
  if (data.ok) {
    alert("‚úÖ School info updated successfully!");
    window.location.reload();
  } else {
    alert("‚ö†Ô∏è " + data.error);
  }
});
</script>

<style>
.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-content {
  background: #fff;
  padding: 25px;
  border-radius: 10px;
  width: 90%;
  max-width: 450px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
  position: relative;
}

.modal-content h2 {
  text-align: center;
  margin-bottom: 15px;
}

.modal-content label {
  display: block;
  margin-top: 10px;
  font-weight: bold;
}

.modal-content input[type="text"],
.modal-content input[type="email"],
.modal-content input[type="file"] {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.btn-save {
  background: #007bff;
  color: #fff;
  border: none;
  padding: 10px 14px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 15px;
  width: 100%;
}

.btn-save:hover { background: #0056b3; }

.close {
  position: absolute;
  top: 10px; right: 15px;
  cursor: pointer;
  font-size: 20px;
  color: #666;
}



.btn-edit:hover {
  background: #007bff;
  color: #fff;
}
</style>
