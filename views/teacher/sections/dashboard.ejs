<h1>ğŸ‘¨â€ğŸ« Teacher Dashboard</h1>

<!-- âœ… Class Selector -->
<div class="class-selector">
  <label for="classSelect">Select Class:</label>
  <select id="classSelect">
    <option value="all">All Classes</option>
    <% classStats.forEach(c => { %>
      <option value="<%= c.id %>"><%= c.class_name %></option>
    <% }) %>
  </select>
</div>

<!-- âœ… Profile / Greeting -->
<div class="profile-box">
  <img src="<%= profile.profile_picture || '/images/default-avatar.png' %>" 
       alt="Profile" class="profile-pic">
  <div>
    <h2>Welcome, <%= profile.fullname %> ğŸ‘‹</h2>
    <p><%= profile.email %></p>
    <p><%= new Date().toLocaleDateString() %></p>
  </div>
</div>

<!-- âœ… Dashboard Content -->
<div id="dashboardContent">
  <!-- âœ… Key Stats -->
  <div class="cards">
    <div class="card">ğŸ‘¥ Students <h3><%= keyStats.total_students || 0 %></h3></div>
    <div class="card">ğŸ« Classes <h3><%= keyStats.total_classes || 0 %></h3></div>
    <div class="card">ğŸ“– Lessons <h3><%= keyStats.lessons_completed || 0 %>/<%= keyStats.total_lessons || 0 %></h3></div>
    <div class="card">ğŸ“ Avg Quiz <h3><%= keyStats.avg_quiz_score || "N/A" %></h3></div>
    <div class="card">ğŸ“‘ Avg Assignment <h3><%= keyStats.avg_assignment_score || "N/A" %></h3></div>
    <div class="card">â³ Engagement <h3><%= keyStats.engagement_last7 || 0 %>%</h3></div>
  </div>

  <!-- âœ… Class Overview -->
  <h2>ğŸ“š Classes</h2>
  <div class="cards">
    <% classStats.forEach(c => { %>
      <div class="card">
        <h3><%= c.class_name %></h3>
        <p>ğŸ‘¥ Students: <%= c.students %></p>
        <p>ğŸ“– Lessons: <%= c.lessons_completed %> / <%= c.total_lessons %> 
           (<%= c.total_lessons ? Math.round((c.lessons_completed / c.total_lessons) * 100) : 0 %>%)</p>
        <p>ğŸ“ Avg Quiz: <%= c.avg_quiz_score || "N/A" %></p>
        <p>ğŸ“‘ Avg Assignment: <%= c.avg_assignment_score || "N/A" %></p>
        <p>â³ Engagement: <%= c.engagement || 0 %>%</p>
        <a class="btn-view" href="/teacher/classroom/<%= c.id %>/students">View Students</a>
      </div>
    <% }) %>
  </div>

  <!-- âœ… Charts -->
  <h2>ğŸ“ˆ Class Progress</h2>
  <canvas id="lessonChart"></canvas>
  <canvas id="quizChart"></canvas>

  <!-- âœ… Student Snapshots -->
  <h2>ğŸ‘¨â€ğŸ“ Top Students</h2>
  <div class="user-table-wrapper">
    <table class="user-table">
      <thead>
        <tr>
          <th>Student</th>
          <th>Average Quiz</th>
        </tr>
      </thead>
      <tbody>
        <% topStudents.forEach(s => { %>
          <tr>
            <td><%= s.fullname %></td>
            <td><%= s.avg_score || "N/A" %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <h2>âš ï¸ Struggling Students</h2>
  <div class="user-table-wrapper">
    <table class="user-table">
      <thead>
        <tr>
          <th>Student</th>
          <th>Lessons Done</th>
        </tr>
      </thead>
      <tbody>
        <% strugglingStudents.forEach(s => { %>
          <tr>
            <td><%= s.fullname %></td>
            <td><%= s.lessons_done || 0 %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- âœ… Notifications -->
  <h2>ğŸ“¬ Notifications</h2>
  <p>Pending Assignments to Grade: <%= pendingAssignments %></p>
</div>

<!-- âœ… Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const labels = <%- JSON.stringify(classStats.map(c => c.class_name || "Unnamed Class")) %>;
  const lessonData = <%- JSON.stringify(classStats.map(c => {
    const completed = c.lessons_completed || 0;
    const total = c.total_lessons || 0;
    return total > 0 ? Math.round((completed / total) * 100) : 0;
  })) %>;
  const quizData = <%- JSON.stringify(classStats.map(c => c.avg_quiz_score || 0)) %>;

  new Chart(document.getElementById('lessonChart'), {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Lesson Completion %', data: lessonData, backgroundColor: '#27ae60' }] },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  new Chart(document.getElementById('quizChart'), {
    type: 'line',
    data: { labels, datasets: [{ label: 'Average Quiz Score', data: quizData, borderColor: '#2980b9', fill: false }] },
    options: { responsive: true }
  });

  document.getElementById('classSelect').addEventListener('change', async function() {
    const classId = this.value;
    try {
      const res = await fetch(`/teacher/dashboard/data?classId=${classId}`);
      const html = await res.text();
      document.getElementById('dashboardContent').innerHTML = html;

      // re-run scripts inside new content (for charts)
      const scriptTags = document.getElementById('dashboardContent').querySelectorAll("script");
      scriptTags.forEach(oldScript => {
        const newScript = document.createElement("script");
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        document.body.appendChild(newScript);
        oldScript.remove();
      });
    } catch (err) {
      console.error('Error loading class dashboard:', err);
    }
  });
</script>
