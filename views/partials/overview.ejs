

<script>
  function toggleCollapse(id) {
    const section = document.getElementById(id);
    section.classList.toggle("active");
  }
</script>

<script>
function openModal(id) {
  document.getElementById(id).style.display = "flex";
}
function closeModal(id) {
  document.getElementById(id).style.display = "none";
}

// Pre-fill edit modal
function openEditModal(classroomId, classroomName, teacherIds) {
  document.getElementById("edit_classroom_id").value = classroomId;
  document.getElementById("edit_name").value = classroomName;

  // Reset teacher select
  const select = document.getElementById("edit_teacher_ids");
  Array.from(select.options).forEach(opt => {
    opt.selected = teacherIds.includes(parseInt(opt.value));
  });

  document.getElementById("editClassroomForm").action = "/school-admin/classrooms/" + classroomId + "/edit";
  openModal("editClassroomModal");
}
</script>


<div class="kpi-row">
  <div class="kpi-card">
    üë®‚Äçüè´ <h3><%= teachers.length %></h3>
    <p>Total Teachers</p>
  </div>
  <div class="kpi-card">
    üéì <h3><%= students.length %></h3>
    <p>Total Students</p>
  </div>
  <div class="kpi-card">
    üè´ <h3><%= classrooms.length %></h3>
    <p>Total Classrooms</p>
  </div>
  <div class="kpi-card">
    ‚è≥ <h3><%= pendingUsers.length %></h3>
    <p>Pending Approvals</p>
  </div>
  <div class="kpi-card">
    üìö <h3><%= classrooms.filter(c => c.modules_count > 0).length %></h3>
    <p>Active Courses</p>
  </div>
</div>

<div class="charts-grid">
  <div class="chart-box">
    <h3>Teachers vs Students</h3>
    <canvas id="teacherStudentChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>Students per Classroom</h3>
    <canvas id="classroomChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>Pending vs Approved</h3>
    <canvas id="pendingChart"></canvas>
  </div>
</div>


<!-- <div class="activity-feed">
<h3>üì∞ Recent Activity</h3>
<ul>
  <% recentActivities.forEach(a => { %>
    <li>
      <strong><%= a.fullname || a.role || "System" %></strong> - <%= a.action %>
      <% if (a.details) { %>: <%= a.details %><% } %>
      <small>(<%= new Date(a.created_at).toLocaleDateString() %>)</small>
    </li>
  <% }) %>
</ul>

</div> -->
<div class="collapsible-header" onclick="toggleCollapse('recent-activity')">
üì∞ Recent Activity (Click to view)
</div>
<div id="recent-activity" class="collapsible-content">
  <div class="table-responsive">
    <table class="user-table">
        <thead>
        <tr>
            <th>User</th>
            <th>Role</th>
            <th>Action</th>
            <th>Details</th>
            <th>Date</th>
        </tr>
        </thead>
        <tbody>
        <% if (recentActivities && recentActivities.length > 0) { %>
            <% recentActivities.forEach(a => { %>
            <tr>
                <td><%= a.fullname || "System" %></td>
                <td><%= a.role || "-" %></td>
                <td><%= a.action %></td>
                <td><%= a.details || "-" %></td>
                <td><%= new Date(a.created_at).toLocaleDateString() %></td>
            </tr>
            <% }) %>
        <% } else { %>
            <tr>
            <td colspan="5" class="text-center">No recent activity</td>
            </tr>
        <% } %>
        </tbody>
    </table>
  </div>
</div>

<div class="collapsible-header" onclick="toggleCollapse('teacher-performance')">
üìä Teacher Performance Snapshot (Click to view)
</div>
<div id="teacher-performance" class="collapsible-content">
  <div class="table-responsive">
    <table class="user-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Classrooms Managed</th>
          <th>Students</th>
          <th>Avg. Engagement</th>
        </tr>
      </thead>
      <tbody>
        <% teacherPerformance.forEach(t => { %>
          <tr>
            <td><%= t.fullname %></td>
            <td><%= t.email %></td>
            <td><%= t.classrooms_assigned %></td>
            <td><%= t.total_students %></td>
            <td>
              <% if (t.avg_engagement && t.avg_engagement > 0) { 
                   let rate = Number(t.avg_engagement).toFixed(1);
                   let color = rate >= 70 ? "green" : rate >= 40 ? "orange" : "red";
              %>
                <span style="color:<%= color %>; font-weight:600;">
                  <%= rate %>%
                </span>
              <% } else { %>
                <span style="color:gray;">N/A</span>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>



<div class="collapsible-header" onclick="toggleCollapse('student-engagement')">
üéØ Student Engagement Snapshot (Click to view)
</div>
<!-- <div id="student-engagement" class="collapsible-content">
  <div class="table-responsive">
    <table class="user-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Lessons Completed</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% studentEngagement.forEach(s => { %>
          <tr>
            <td><%= s.fullname %></td>
            <td><%= s.email %></td>
            <td><%= s.lessons_completed %></td>
            <td>
              <% if (s.lessons_completed < 5) { %>
                üö® At Risk
              <% } else { %>
                ‚úÖ Active
              <% } %>
            </td>
            <td>
              <button class="btn-edit">üì© Remind</button>
              <button class="btn-view">üë®‚Äçüè´ Assign Mentor</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div> -->

<div id="student-engagement" class="collapsible-content">
  <div class="table-responsive">
    <table class="user-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Lessons Completed</th>
          <th>Engagement</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% studentEngagement.forEach(s => { %>
          <tr>
            <td><%= s.fullname %></td>
            <td><%= s.email %></td>
            <td><%= s.lessons_completed %> / <%= s.total_lessons %></td>
            <td><%= s.engagement_rate %>%</td>
            <td>
              <% if (s.engagement_rate < 30) { %>
                üö® At Risk
              <% } else if (s.engagement_rate < 70) { %>
                ‚ö†Ô∏è Needs Attention
              <% } else { %>
                ‚úÖ Active
              <% } %>
            </td>
            <td>
              <button class="btn-edit">üì© Remind</button>
              <button class="btn-view">üë®‚Äçüè´ Assign Mentor</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>


<!-- <form method="POST" action="/school-admin/approvals/bulk">
  <select name="filterRole" onchange="this.form.submit()">
    <option value="">All</option>
    <option value="teacher">Teachers</option>
    <option value="student">Students</option>
  </select>
  
  <button type="submit" name="action" value="approve">Approve Selected</button>
  <button type="submit" name="action" value="reject">Reject Selected</button>
  
  <table>
    <thead>
      <tr>
        <th><input type="checkbox" onclick="toggleAll(this)"></th>
        <th>Name</th><th>Email</th><th>Role</th><th>Applied On</th>
      </tr>
    </thead>
    <tbody>
      <% pendingUsers.forEach(u => { %>
        <tr>
          <td><input type="checkbox" name="userIds" value="<%= u.id %>"></td>
          <td><%= u.fullname %></td>
          <td><%= u.email %></td>
          <td><%= u.role_in_school %></td>
          <td><%= new Date(u.joined_at).toDateString() %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</form> -->


<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Get data from EJS locals
  const teachers = <%- JSON.stringify(teachers) %>;
  const students = <%- JSON.stringify(students) %>;
  const classrooms = <%- JSON.stringify(classrooms) %>;
  const pendingUsers = <%- JSON.stringify(pendingUsers) %>;

  // === Chart 1: Teachers vs Students ===
  new Chart(document.getElementById("teacherStudentChart"), {
    type: "pie",
    data: {
      labels: ["Teachers", "Students"],
      datasets: [{
        data: [teachers.length, students.length],
        backgroundColor: ["#36A2EB", "#FF6384"]
      }]
    }
  });

  // === Chart 2: Students per Classroom ===
  new Chart(document.getElementById("classroomChart"), {
    type: "bar",
    data: {
      labels: classrooms.map(c => c.name),
      datasets: [{
        label: "Students",
        data: classrooms.map(c => c.student_count),
        backgroundColor: "#4BC0C0"
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });

  // === Chart 3: Pending vs Approved ===
  const approvedCount = teachers.length + students.length;
  const pendingCount = pendingUsers.length;

  new Chart(document.getElementById("pendingChart"), {
    type: "doughnut",
    data: {
      labels: ["Approved", "Pending"],
      datasets: [{
        data: [approvedCount, pendingCount],
        backgroundColor: ["#4CAF50", "#FFCE56"]
      }]
    }
  });
</script>

<div style="margin: 1rem 0; text-align:right;">
  <button class="btn-edit" id="approveAllBtn" style="background:green;color:white;">
    ‚úî Approve All
  </button>
</div>

<script>
document.getElementById("approveAllBtn").addEventListener("click", async () => {
  if (!confirm("Approve all pending users?")) return;
  const res = await fetch("/school-admin/approve-all", {
    method: "POST",
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });
  const data = await res.json();
  if (data.success) {
    alert("All users approved!");
    location.reload(); // or dynamically remove rows if you want no reload
  } else {
    alert("Error: " + data.error);
  }
});

// Approve single user without reload
async function approveUser(userId) {
  const res = await fetch(`/school-admin/approve/${userId}`, {
    method: "POST",
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });
  const data = await res.json();
  if (data.success) {
    document.querySelector(`#user-row-${userId}`).remove();
  } else {
    alert("Error: " + data.error);
  }
}
</script>



    <!-- Pending Approvals -->
    <div class="collapsible-header" onclick="toggleCollapse('pending-users')">
    ‚è≥ Pending Teacher/Student Approvals (Click to view)
    </div>
    <div id="pending-users" class="collapsible-content">
    <div class="table-responsive">
        <table class="user-table">
        <thead>
            <tr>
            <th>Profile</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Role in School</th>
            <th>Applied On</th>
            <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <% if (pendingUsers.length) { %>
            <% pendingUsers.forEach(user => { %>
                <!-- <tr>
                <td>
                    <img src="<%= user.profile_picture || '/profile.webp' %>" 
                        alt="Profile"
                        style="width:50px; height:50px; border-radius:50%;">
                </td>
                <td><%= user.fullname %></td>
                <td><%= user.email %></td>
                <td><%= user.role_in_school %></td>
                <td><%= new Date(user.joined_at).toDateString() %></td>
                <td sstyle="
                    display: flex;
                    gap: 10px;
                    justify-content: center;
                    align-items: center;
                ">
                    
                    <div class="article-buttons">
                        <form method="POST" action="/school-admin/approve/<%= user.id %>">
                            <button class="btn-edit" style="background:green; color:white;">‚úî Approve</button>
                        </form>

                    <form method="POST" action="/school-admin/reject/<%= user.id %>">
                    <button class="btn-delete" style="background:red; color:white;">‚úñ Reject</button>
                    </form>

                    </div>
                </td>
                </tr> -->

                <tr id="user-row-<%= user.id %>">
                  <td>
                    <img src="<%= user.profile_picture || '/profile.webp' %>" ...>
                  </td>
                  <td><%= user.fullname %></td>
                  <td><%= user.email %></td>
                  <td><%= user.role_in_school %></td>
                  <td><%= new Date(user.joined_at).toDateString() %></td>
                  <td>
                    <button onclick="approveUser(<%= user.id %>)" class="btn-edit" style="background:green;color:white;">‚úî Approve</button>
                    <form method="POST" action="/school-admin/reject/<%= user.id %>">
                      <button class="btn-delete" style="background:red;color:white;">‚úñ Reject</button>
                    </form>
                  </td>
                </tr>

            <% }) %>
            <% } else { %>
            <tr>
                <td colspan="6" style="text-align:center;">No pending approvals</td>
            </tr>
            <% } %>
        </tbody>
        </table>
    </div>
    </div>

    <!-- Approved Teachers -->
    <div class="collapsible-header" onclick="toggleCollapse('teachers')">
    üë®‚Äçüè´ Approved Teachers (Click to view)
    </div>
    <div id="teachers" class="collapsible-content">
    <div class="table-responsive">
        <table class="user-table">
        <thead>
            <tr>
            <th>Full Name</th>
            <th>Email</th>
            <th>Joined On</th>
            </tr>
        </thead>
        <tbody>
            <% if (teachers.length) { %>
            <% teachers.forEach(t => { %>
                <tr>
                <td><%= t.fullname %></td>
                <td><%= t.email %></td>
                <td><%= new Date(t.joined_at).toDateString() %></td>
                </tr>
            <% }) %>
            <% } else { %>
            <tr><td colspan="3" style="text-align:center;">No teachers yet</td></tr>
            <% } %>
        </tbody>
        </table>
    </div>
    </div>

    <!-- Approved Students -->
    <div class="collapsible-header" onclick="toggleCollapse('students')">
    üéì Approved Students (Click to view)
    </div>
    <div id="students" class="collapsible-content">
    <div class="table-responsive">
        <table class="user-table">
        <thead>
            <tr>
            <th>Full Name</th>
            <th>Email</th>
            <th>Joined On</th>
            </tr>
        </thead>
        <tbody>
            <% if (students.length) { %>
            <% students.forEach(s => { %>
                <tr>
                <td><%= s.fullname %></td>
                <td><%= s.email %></td>
                <td><%= new Date(s.joined_at).toDateString() %></td>
                </tr>
            <% }) %>
            <% } else { %>
            <tr><td colspan="3" style="text-align:center;">No students yet</td></tr>
            <% } %>
        </tbody>
        </table>
    </div>
    </div>

    <!-- Classrooms -->
    <div class="collapsible-header" onclick="toggleCollapse('classrooms')">
    üè´ Classrooms (Click to view)
    </div>
    <div id="classrooms" class="collapsible-content">
    <!-- Trigger Button -->
    <!-- <button class="btn-edit" onclick="openModal()">‚ûï Create Classroom</button> -->
    <button class="btn-edit" onclick="openModal('createClassroomModal')">
    ‚ûï Create Classroom
    </button>

    <div class="table-responsive">
        <table class="user-table">
        <thead>
            <tr>
            <th>Classroom Name</th>
            <th>Teacher</th>
            <th>Students</th>
            <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <% if (classrooms.length) { %>
            <% classrooms.forEach(c => { %>
                <tr>
                <td><%= c.name %></td>
                <!-- <td><%= c.teacher_name || 'Unassigned' %></td> -->
                <td><%= c.teacher_names %></td>
                <td><%= c.student_count %></td>
                <td style="
                    display: flex;
                    gap: 10px;
                    justify-content: center;
                    align-items: center;
                ">
                <div class="article-button">
                    <!-- <button
                        class="btn-view"
                        onclick="window.location.href='/school-admin/classrooms/<%= c.id %>'"
                    >
                        üëÅ View
                    </button> -->

                    <button
                        class="btn-view"
                        onclick="openClassroom('<%= c.id %>')">
                        üëÅ View
                    </button>


                <button class="btn-edit"
                            onclick="openEditModal(<%= c.id %>, '<%= c.name %>', <%- JSON.stringify(c.teacher_ids || []) %>)">
                        ‚úè Edit
                    </button>


                    
                    <form method="POST" action="/school-admin/classrooms/<%= c.id %>/delete" 
                        onsubmit="return confirm('Delete this classroom?')">
                        <button type="submit" class="btn-delete">üóë Delete</button>
                    </form>


                    <!-- <button
                        class="btn-delete"
                        onclick="window.location.href='/school-admin/classrooms/<%= c.id %>/delete'"
                    >
                        üóë Delete
                    </button> -->
                    </div>
                </td>
                </tr>
            <% }) %>
            <% } else { %>
            <tr><td colspan="4" style="text-align:center;">No classrooms yet</td></tr>
            <% } %>
        </tbody>
        </table>
    </div>
    </div>

    <!-- Create Classroom Modal -->
    <div id="createClassroomModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('createClassroomModal')">&times;</span>
        <h2>‚ûï Create Classroom</h2>

        <form method="POST" action="/school-admin/classrooms/new">
        <label for="name">Classroom Name</label>
        <input type="text" name="name" id="name" required>

        <label for="teacher_id">Assign Teachers (optional)</label>
        <select name="teacher_id" id="teacher_id" multiple size="5">
            <% teachers.forEach(t => { %>
            <option value="<%= t.id %>"><%= t.fullname %> (<%= t.email %>)</option>
            <% }) %>
        </select>
        <small>Hold <b>Ctrl</b> (Windows) or <b>Cmd</b> (Mac) to select multiple</small>

        <button type="submit" class="btn-edit">Create</button>
        </form>
    </div>
    </div>

    <!-- Reusable Edit Modal -->
    <!-- <div id="editClassroomModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('createClassroomModal')">&times;</span>

        <h2>‚úè Edit Classroom</h2>
        <form id="editClassroomForm" method="POST">
        <input type="hidden" name="id" id="edit_classroom_id">

        <label for="edit_name">Classroom Name</label>
        <input type="text" name="name" id="edit_name" required>

        <label for="teacher_id">Assign Teachers</label>
        <select name="teacher_id" id="edit_teacher_ids" multiple size="5">
            <% teachers.forEach(t => { %>
                <option value="<%= t.id %>">
                <%= t.fullname %> (<%= t.email %>)
                </option>
            <% }) %>
            </select>

        <small>Hold <b>Ctrl</b> (Windows) or <b>Cmd</b> (Mac) to select multiple</small>

        <button type="submit" class="btn-edit">Update</button>
        </form>
    </div>
    </div> -->

    <!-- Reusable Edit Modal -->
<div id="editClassroomModal" class="modal-overlay">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('editClassroomModal')">&times;</span>
    <h2>‚úè Edit Classroom</h2>
    <form id="editClassroomForm" method="POST">
      <input type="hidden" name="id" id="edit_classroom_id">

      <label for="edit_name">Classroom Name</label>
      <input type="text" name="name" id="edit_name" required>

      <label for="teacher_id">Assign Teachers</label>
      <select name="teacher_id" id="edit_teacher_ids" multiple size="5">
        <% teachers.forEach(t => { %>
          <option value="<%= t.id %>"><%= t.fullname %> (<%= t.email %>)</option>
        <% }) %>
      </select>

      <small>Hold <b>Ctrl</b> (Windows) or <b>Cmd</b> (Mac) to select multiple</small>

      <button type="submit" class="btn-edit">Update</button>
    </form>
  </div>
</div>

<script>
function openClassroom(classroomId) {
  // Navigate to dashboard with query parameter
  window.location.href = `/school-admin/dashboard?openClassroom=${classroomId}#classrooms`;
}
</script>

