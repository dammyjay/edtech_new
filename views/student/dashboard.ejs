<%- include('../partials/header', { title: 'Dashboard' }) %>

<button id="toggleSidebar" class="hamburger" style="margin-bottom: 20px">
  â˜°
</button>

<div class="dashboard-container">

<aside class="sidebar">
  <div class="logo-title">
    <% if (info?.logo_url) { %>
      <a href="/"><img src="<%= info.logo_url %>" alt="Logo" /></a>
    <% } %>
    <p><%= info?.company_name || 'C&S Church Online' %></p>
  </div>

  <div class="sidebar-header">
    <% if (profilePic) { %>
      <img src="<%= profilePic %>" alt="Profile Picture" class="profile-pic" />
    <% } else { %>
      <img src="/images/profile male.png" alt="Default Profile Picture" class="profile-pic" />
    <% } %>
  </div>

  <h2 style="font-size: 14px;">ğŸ‘¤ <%= student.fullname %></h2>
  <h2 style="font-size: 14px; color: #e5f0ff;">ğŸª™ Xp: <%= student.xp %> points</h2>

  <ul class="sidebar-nav">
    <li><a href="/student/dashboard">ğŸ  Dashboard</a></li>
    <li><a href="/student/dashboard?section=profile">ğŸ‘¤ My Profile</a></li>
    <p style="color: rgb(255, 255, 255);">ğŸ’° Wallet: â‚¦<%= walletBalance.toLocaleString() %></p>

    <!-- Collapsible: School Info -->
    <% if (student.role === 'student' && school) { %>
      <li>
        <button class="dropdown-btn">ğŸ« School Info â–¾</button>
        <div class="dropdown-container">
          <% if (school.logo_url) { %>
            <img src="<%= school.logo_url %>" alt="School Logo" style="height:50px; margin-bottom:10px;">
          <% } %>
          <p><strong>School:</strong> <%= school.name %></p>
          <p><strong>Classroom:</strong> <%= classroom?.name || 'Not assigned yet' %></p>
          <p><strong>Teacher:</strong> <%= teacher?.fullname || 'Unassigned' %></p>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <a href="/student/dashboard?section=classroom" class="btn-view">ğŸ‘¥ Classmates</a>
            <a href="/student/dashboard?section=teacher" class="btn-edit">ğŸ‘¨â€ğŸ« Your Teacher</a>
            <a href="/student/dashboard?section=instructors" class="btn-edit">ğŸ§‘ğŸ½â€ğŸ”§ Instructors</a>
          </div>
        </div>
      </li>
    <% } %>

    <!-- Collapsible: Parents -->
    <li>
      <button class="dropdown-btn">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parents â–¾</button>
      <div class="dropdown-container">
        <% if (parents && parents.length > 0) { %>
          <ul>
            <% parents.forEach(parent => { %>
              <li><strong><%= parent.fullname %></strong> (<%= parent.email %>)</li>
            <% }) %>
          </ul>
        <% } else { %>
          <p>No parent linked yet.</p>
        <% } %>

        <% if (parentRequests && parentRequests.length > 0) { %>
          <h4>ğŸ“© Requests</h4>
          <ul>
            <% parentRequests.forEach(req => { %>
              <li>
                <strong><%= req.parent_name %></strong> (<%= req.parent_email %>)
                <form action="/student/parent-request/respond" method="POST" style="display:inline-flex; gap:6px;">
                  <input type="hidden" name="requestId" value="<%= req.id %>">
                  <button type="submit" name="action" value="approve">âœ…</button>
                  <button type="submit" name="action" value="reject">âŒ</button>
                </form>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </div>
    </li>

    <!-- Collapsible: Pathways -->
    <li>
      <button class="dropdown-btn">ğŸ“‚ My Pathways â–¾</button>
      <ul class="dropdown-container">
        <% Object.keys(pathwayCourses).forEach(pathway => { %>
          <li>
            <a href="/student/dashboard?pathway=<%= encodeURIComponent(pathway) %>">
              <%= pathway %>
            </a>
          </li>
        <% }) %>
      </ul>
    </li>

    <li><a href="/admin/logout">ğŸšª Logout</a></li>
  </ul>
</aside>


 <main class="main-content">
  
  <% if (section === 'profile') { %>
    <!-- ğŸ‘¤ PROFILE SECTION -->
    <div class="profile-container">
  <h2>ğŸ‘¤ My Profile</h2>

  <div class="profile-card">
    <img src="<%= profilePic || '/images/profile male.png' %>" class="profile-pic-large" />
    <p><strong>Full Name:</strong> <%= student.fullname %></p>
    <p><strong>Gender:</strong> <%= student.gender %></p>
    <p><strong>Date of Birth:</strong> <%= student.dob ? student.dob.toISOString().split('T')[0] : 'N/A' %></p>
    <p style="color: rgb(0, 0, 0);">ğŸ’° Wallet: â‚¦<%= walletBalance.toLocaleString() %></p>
    <button class="btn-create" onclick="openEditModal('profile')">âœï¸ Edit Profile</button>
  </div>

  <!-- ğŸ… Achievements -->
  <h3>ğŸ… Achievements</h3>
  <div class="achievements">
    <div class="achievement-item">
      <h4>ğŸª™ XP Points</h4>
      <p><%= student.xp || 0 %> points</p>
    </div>

    <div class="achievement-item">
      <h4>ğŸ“˜ Courses Completed</h4>
      <p><%= completedCourses || 0 %></p>
    </div>

    <div class="achievement-item">
      <h4>ğŸ“œ Certificates</h4>
      <p><%= certificatesCount || 0 %></p>
    </div>
  </div>

  <!-- ğŸ“œ Certificates Section -->
  <div class="certificates-section">
    <h3>ğŸ“œ My Certificates</h3>
    <% if (certificates && certificates.length > 0) { %>
      <div class="certificates-grid">
        <% certificates.forEach(c => { %>
          <div class="certificate-card">
            <h4><%= c.course_title %></h4>
            <p>Issued: <%= new Date(c.issued_date).toLocaleDateString() %></p>
            <% if (c.certificate_url) { %>
              <a href="<%= c.certificate_url %>" target="_blank" class="btn-view">ğŸ”— View Certificate</a>
            <% } else { %>
              <p>No link available</p>
            <% } %>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <p class="no-certificates">No certificates yet. Complete courses to earn yours! ğŸ“</p>
    <% } %>
  </div>

  <!-- ğŸ–ï¸ Badges Section -->
  <!-- <div class="badges-section">
    <h3>ğŸ–ï¸ Badges Earned</h3>
    <% if (badges && badges.length > 0) { %>
      <div class="badges-grid">
        <% badges.forEach(b => { %>
          <div class="badge-card">
            <div class="badge-icon">
              <% if (b.badge_name === 'Beginner') { %> ğŸ¥‰
              <% } else if (b.badge_name === 'Intermediate') { %> ğŸ¥ˆ
              <% } else if (b.badge_name === 'Advanced') { %> ğŸ¥‡
              <% } else if (b.badge_name === 'Master') { %> ğŸ‘‘
              <% } else { %> ğŸ–ï¸
              <% } %>
            </div>
            <p class="badge-name"><%= b.badge_name %></p>
            <p class="badge-date">Awarded: <%= new Date(b.awarded_at).toLocaleDateString() %></p>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <p class="no-badges">No badges earned yet. Keep learning! ğŸš€</p>
    <% } %>
  </div> -->
  <div class="badges-section">
  <h3>ğŸ–ï¸ Badges Earned</h3>

  <% if (badges && badges.length > 0) { %>
    <div class="badges-grid">
      <% badges.forEach(b => { %>
        <div class="badge-card">
          <!-- Show badge image if exists -->
          <% if (b.badge_image) { %>
            <img src="<%= b.badge_image %>" alt="<%= b.badge_name %>" class="badge-img" />
          <% } else { %>
            <div class="badge-placeholder">ğŸ–ï¸</div>
          <% } %>

          <p class="badge-name"><%= b.badge_name %></p>
          <p class="badge-date">Awarded: <%= new Date(b.awarded_at).toLocaleDateString() %></p>

          <!-- Optional: show module title that earned this badge -->
          <% if (b.module_title) { %>
            <p class="badge-module">Module: <%= b.module_title %></p>
          <% } %>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <p class="no-badges">No badges earned yet. Keep learning! ğŸš€</p>
  <% } %>
</div>


</div>


  <% } else if (section === 'classroom' && classroom) { %>
  <h2>ğŸ‘¥ Your Classmates in <%= classroom.name %></h2>
  <% if (classmates.length > 0) { %>
    <div class="table-responsive">
      <table class="user-table">
        <thead>
          <tr>
            <th>Profile</th>
            <th>Full Name</th>
            <th>Email</th>
          </tr>
        </thead>
        <tbody>
          <% classmates.forEach(c => { %>
            <tr>
              <td>
                <img src="<%= c.profile_picture || '/images/profile male.png' %>" 
                    alt="Profile" 
                    style="width:40px; height:40px; border-radius:50%;">
              </td>
              <td><%= c.fullname %></td>
              <td><%= c.email %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } else { %>
    <p>No classmates found in this classroom.</p>
  <% } %>

<% } else if (section === 'teacher' && classroom) { %>
  <h2>ğŸ‘¨â€ğŸ« Your Teacher(s) for <%= classroom.name %></h2>
  <% if (teachers.length > 0) { %>
    <div class="card-container">
      <% teachers.forEach(t => { %>
        <div class="card">
          <div class="card-header">
            <img src="<%= t.profile_picture || '/images/profile male.png' %>" 
                 alt="Teacher" 
                 class="card-avatar" style=" object-fit:contain;">
            <h3><%= t.fullname %></h3>
          </div>
          <!-- <div class="card-body">
            <p><strong>Email:</strong> <%= t.email %></p>
            <p><strong>Role:</strong> Teacher</p>
          </div> -->
          <div class="card-body">
            <p><strong>Email:</strong> <%= t.email %></p>
            <p><strong>Role:</strong> Teacher</p>

            <!-- ğŸ’¬ Chat Button -->
            <button class="btn-chat" onclick="openChat('<%= t.id %>', '<%= t.fullname %>')">ğŸ’¬ Chat</button>

           
          </div>

        </div>
         <!-- Chat Modal -->
            <div id="chatModal-<%= t.id %>" class="chat-modal">
              <div class="chat-content">
                <span class="close-chat" onclick="closeChat('<%= t.id %>')">&times;</span>
                <h3>Chat with <%= t.fullname %></h3>
                <div class="chat-messages" id="chatMessages-<%= t.id %>"></div>
                <div class="chat-input">
                  <input type="text" id="chatInput-<%= t.id %>" placeholder="Type a message..." />
                  <button onclick="sendChat('<%= t.id %>')">Send</button>
                </div>
              </div>
            </div>
      <% }) %>
    </div>
  <% } else { %>
    <p>No teacher assigned to this classroom yet.</p>
  <% } %>

  <% } else if (section === 'instructors' && classroom) { %>
  <h2>ğŸ§‘ğŸ½â€ğŸ”§ Your Instructors for <%= classroom.name %></h2>
  <% if (instructors.length > 0) { %>
    <div class="card-container">
      <% instructors.forEach(i => { %>
        <div class="card">
          <div class="card-header">
            <img src="<%= i.profile_picture || '/images/profile male.png' %>" 
                 alt="Instructor" 
                 class="card-avatar" style="object-fit:contain;">
            <h3><%= i.fullname %></h3>
          </div>
          <!-- <div class="card-body">
            <p><strong>Email:</strong> <%= i.email %></p>
            <p><strong>Role:</strong> Instructor</p>
          </div> -->
        
           <div class="card-body">
              <p><strong>Email:</strong> <%= i.email %></p>
              <p><strong>Role:</strong> Instructor</p>

              <!-- ğŸ’¬ Chat Button -->
              <button class="btn-chat" onclick="openChat('<%= i.id %>', '<%= i.fullname %>')">ğŸ’¬ Chat</button>

             
            </div>
        </div>
         <!-- Chat Modal -->
              <div id="chatModal-<%= i.id %>" class="chat-modal">
                <div class="chat-content">
                  <span class="close-chat" onclick="closeChat('<%= i.id %>')">&times;</span>
                  <h3>Chat with <%= i.fullname %></h3>
                  <div class="chat-messages" id="chatMessages-<%= i.id %>"></div>
                  <div class="chat-input">
                    <input type="text" id="chatInput-<%= i.id %>" placeholder="Type a message..." />
                    <button onclick="sendChat('<%= i.id %>')">Send</button>
                  </div>
                </div>
              </div>
      <% }) %>
    </div>
  <% } else { %>
    <p>No instructor assigned to this classroom yet.</p>
  <% } %>



  <% } else if (section === 'module' && moduleInfo) { %>
  <!-- LEARNING VIEW -->
  <div class="learning-container">
    <!-- Mini Sidebar -->
    
<aside class="lesson-sidebar">
  <h3>All Modules</h3>
  <% Object.keys(courseModules).forEach(courseId => { %>
    <% courseModules[courseId].forEach(module => { %>
      <div class="module-block">
        <button style="text-align: left;" class="module-toggle no-bg" onclick="toggleModule(<%= module.id %>)">
          ğŸ“¦ <%= module.title %> â–¾
        </button>

        <!-- <button 
          class="module-toggle no-bg"
          <%= module.unlocked 
                ? "onclick='toggleModule(" + module.id + ")'" 
                : "disabled style=\"opacity:0.5; cursor:not-allowed;\"" %>>
          <%= module.unlocked ? "ğŸ“¦" : "ğŸ”’" %> <%= module.title %> â–¾
        </button> -->
        <ul id="module-<%= module.id %>" class="lesson-list" style="display:none;">
          <% (moduleLessons[module.id] || []).forEach(lesson => { %>
            <li>
              <!-- <button class="lesson-toggle no-bg" onclick="toggleLessonMenu(<%= lesson.id %>)">
                ğŸ“š <%= lesson.title %> â–¾
              </button> -->
              <!-- <button class="lesson-toggle no-bg" onclick="toggleLessonMenu(<%= lesson.id %>)">
                <%= lesson.unlocked ? "ğŸ“š" : "ğŸ”’" %> <%= lesson.title %> â–¾
              </button> -->

              <!-- <button class="lesson-toggle no-bg"
                      <%= lesson.unlocked ? "onclick='toggleLessonMenu(" + lesson.id + ")'" : "disabled style='opacity:0.5; cursor:not-allowed;'" %>>
                <%= lesson.unlocked ? "ğŸ“š" : "ğŸ”’" %> <%= lesson.title %> â–¾
              </button> -->

              <!-- <ul id="lesson-menu-<%= lesson.id %>" style="display:none; padding-left:15px;">
                <% /* Video */ %>
                <li><button class="no-bg" onclick="loadLessonPart(<%= lesson.id %>, 'video')">ğŸ¥ Video</button></li>
                <% /* Lesson Note */ %>
                <li><button class="no-bg" onclick="loadLessonPart(<%= lesson.id %>, 'content')">ğŸ“ Lesson Note</button></li>
                <% /* Quiz */ %>
                <li><button class="no-bg" onclick="loadLessonPart(<%= lesson.id %>, 'quiz')">ğŸ“ Quiz</button></li>
              </ul> -->

              <button class="lesson-toggle no-bg"
                      onclick="handleLessonClick(<%= lesson.id %>, <%= lesson.unlocked %>)"
                      style="text-align: left; <%= lesson.unlocked ? '' : 'opacity:0.5; cursor:not-allowed;' %>">
                <%= lesson.unlocked ? "ğŸ“š" : "ğŸ”’" %> <%= lesson.title %> â–¾
              </button>

              <ul id="lesson-menu-<%= lesson.id %>" style="display:none; padding-left:15px;">
                <li><button class="no-bg" onclick="loadLessonPart(<%= lesson.id %>, 'video')">ğŸ¥ Video</button></li>
                <li><button class="no-bg" onclick="loadLessonPart(<%= lesson.id %>, 'content')">ğŸ“ Lesson Note</button></li>
                <li><button class="no-bg" onclick="loadLessonPart(<%= lesson.id %>, 'quiz')">ğŸ“ Quiz</button></li>
              </ul>

            </li>
          <% }) %>
          <h3>Assignments</h3>
          <% (moduleAssignments[module.id] || []).forEach(assign => { %>
            <li>
              <!-- <button class="no-bg" onclick="loadAssignment(<%= assign.id %>)">
                ğŸ“‘ <%= assign.title %>
              </button> -->
              <!-- <button class="no-bg"
                      <%= module.unlocked ? "onclick='loadAssignment(" + assign.id + ")'" : "disabled style='opacity:0.5; cursor:not-allowed;'" %>>
                <%= module.unlocked ? "ğŸ“‘" : "ğŸ”’" %> <%= assign.title %>
              </button> -->
              <!-- <button 
                class="no-bg"
                data-id="<%= assign.id %>"
                <%= assign.unlocked 
                      ? 'onclick="loadAssignment(this.dataset.id)"' 
                      : 'disabled style="opacity:0.5; cursor:not-allowed;"' %>>
                <%= assign.unlocked ? "ğŸ“‘" : "ğŸ”’" %> <%= assign.title %>
              </button> -->

              <!-- <button 
                class="no-bg"
                data-id="<%= assign.id %>"
                <%= assign.unlocked 
                      ? 'onclick="loadAssignment(Number(this.dataset.id))"' 
                      : 'disabled style="opacity:0.5; cursor:not-allowed;"' %>>
                <%= assign.unlocked ? "ğŸ“‘" : "ğŸ”’" %> <%= assign.title %>
              </button> -->

              <button 
                class="no-bg assignment-btn"
                data-id="<%= assign.id %>"
                <%= assign.unlocked 
                      ? '' 
                      : 'disabled style="opacity:0.5; cursor:not-allowed;"' %>>
                <%= assign.unlocked ? "ğŸ“‘" : "ğŸ”’" %> <%= assign.title %>
              </button>



            </li>
          <% }) %>
        </ul>

        <!-- <h3>Assignments</h3>
        <ul>
          <% (moduleAssignments[module.id] || []).forEach(assign => { %>
            <li onclick="loadAssignmentPart(<%= assign.id %>)">
              ğŸ“‘ <%= assign.title %>
            </li>
          <% }) %>
        </ul> -->
      </div>
    <% }) %>
  <% }) %>

<h3>ğŸ Final Project</h3>
<% enrolledCourses.forEach(course => { %>
  <% if (courseFinalUnlocked[course.id]) { %>
    <% const projects = courseProjects[course.id] || []; %>
    <% projects.forEach(project => { %>
      <button onclick="loadProject(<%= project.id %>)">
        ğŸ¯ <%= project.title %>
      </button>
    <% }) %>
  <% } else { %>
    <p style="opacity:0.5;">ğŸ”’ Complete all modules to unlock the final project for <%= course.title %></p>
  <% } %>
<% }) %>


</aside>


    <!-- Lesson Content Area -->

 <div class="lesson-main-area" id="lessonMainArea">
  <p>Select a lesson to start learning.</p>

</div>
<!-- Project Area (hidden by default) -->
<div id="projectArea" style="display:none; padding: 15px;">
  <% enrolledCourses.forEach(course => { %>
    <h3>ğŸ Projects for <%= course.title %></h3>

    <% const projects = courseProjects[course.id] || []; %>

    <% if (projects.length > 0) { %>
      <% projects.forEach(project => { %>
        <div class="project-card" style="padding: 15px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px;">
          <h4>ğŸ¯ <%= project.title %></h4>
          <p><%= project.description || "Complete this project after finishing all modules." %></p>
          <% if (project.due_date) { %>
            <p>â° Due: <%= new Date(project.due_date).toLocaleDateString() %></p>
          <% } %>

          <% 
            // Check if student has submitted this project
            const submission = projectSubmissions[project.id] || projectSubmissions[course.id];
          %>

          <% if (submission) { %>
            <p>âœ… You submitted this project on <%= new Date(submission.submitted_at).toLocaleDateString() %></p>
            <a href="<%= submission.file_url %>" target="_blank">View Submission</a>
          <% } else { %>
            <form id="projectForm-<%= project.id %>" enctype="multipart/form-data" method="POST" action="/student/projects/submit">
              <input type="hidden" name="courseId" value="<%= course.id %>">
              <input type="hidden" name="projectId" value="<%= project.id %>">

              <label>Upload Project File:</label>
              <input type="file" name="projectFile" required />

              <label>Notes (optional):</label>
              <textarea name="notes" placeholder="Add any notes about your project"></textarea>

              <button type="submit" class="btn-submit">Submit Project</button>
            </form>
          <% } %>
        </div>
      <% }) %>
    <% } else { %>
      <p>No projects available for this course yet.</p>
    <% } %>

  <% }) %>
</div>



  <!-- AI TUTOR BOX -->
  <div id="ai-tutor" class="ai-tutor" style="display:none;">
    <div class="ai-tutor-header">
      ğŸ¤– JKT Hub AI Tutor
      <div class="ai-controls">
        <button id="ai-fullscreen" class="ai-circle-btn">â›¶</button>
        <button id="ai-toggle" class="ai-circle-btn">â€“</button>
      </div>
    </div>

    <div id="ai-messages" class="ai-messages"></div>

    <div class="ai-input-row">
      <input id="ai-question" type="text" placeholder="Ask about your lessonâ€¦" />
      <button id="ai-send">Send</button>
    </div>
  </div>

  <!-- FLOATING MINIMIZED ICON -->
  <div id="ai-float" class="ai-float" title="Open AI Tutor">ğŸ¤–</div>



    <!-- Quiz Results Overlay -->
    <div id="quizResultsOverlay" style="display:none;">
      <div class="overlay-content">
        <h2>Your Quiz Results</h2>
        <p id="quizScore"></p>
        <p id="quizMessage"></p>
        <button onclick="reviewQuiz()">ğŸ” Review Quiz</button>
        <button onclick="goToNextLesson()">â¡ Next Lesson</button>
        <button onclick="closeResults()">âŒ Close</button>
      </div>
    </div>
</div>

  <% } else if (!selectedPathway || !pathwayCourses[selectedPathway]) { %>
    <!-- DASHBOARD VIEW -->
    <section class="stats-boxes">
      <div class="stat-box light-blue">
        <h4>ğŸ“˜ Courses Completed</h4>
        <p><%= completedCourses %></p>
      </div>
      <div class="stat-box light-pink">
        <h4>ğŸ—‚ï¸ Completed Projects</h4>
        <p><%= completedProjects %></p>
      </div>
      <div class="stat-box light-yellow badge-box" onclick="openBadgeModal()">
        <h4>ğŸ… Badges Earned</h4>
        <p><%= badges.length %></p>
        <small style="cursor:pointer;">View All âœ</small>
      </div>
      <div class="stat-box light-grey">
        <h4>ğŸ“œ Certificates</h4>
        <p><%= certificatesCount %></p>
      </div>
    </section>

    <!-- <section class="badges-section">
      <h3>ğŸ… Your Badges</h3>
      <% if (badges && badges.length > 0) { %>
        <div class="badges-grid">
          <% badges.forEach(b => { %>
            <div class="badge-card">
              <div class="badge-icon">
                <% if (b.badge_name === 'Beginner') { %> ğŸ¥‰
                <% } else if (b.badge_name === 'Intermediate') { %> ğŸ¥ˆ
                <% } else if (b.badge_name === 'Advanced') { %> ğŸ¥‡
                <% } else if (b.badge_name === 'Master') { %> ğŸ‘‘
                <% } else { %> ğŸ–ï¸
                <% } %>
              </div>
              <p class="badge-name"><%= b.badge_name %></p>
              <p class="badge-date">Awarded: <%= new Date(b.awarded_at).toLocaleDateString() %></p>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <p>You havenâ€™t earned any badges yet. Keep learning! ğŸš€</p>
      <% } %>
    </section> -->

    <!-- BADGE MODAL -->
<div id="badgeModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeBadgeModal()">&times;</span>
    <h3>ğŸ… Your Badges</h3>

    <% if (badges && badges.length > 0) { %>
      <div class="badges-grid">
        <% badges.forEach(b => { %>
          <div class="badge-card">
            <div class="badge-icon">
              <% if (b.badge_name === 'Beginner') { %> ğŸ¥‰
              <% } else if (b.badge_name === 'Intermediate') { %> ğŸ¥ˆ
              <% } else if (b.badge_name === 'Advanced') { %> ğŸ¥‡
              <% } else if (b.badge_name === 'Master') { %> ğŸ‘‘
              <% } else { %> ğŸ–ï¸
              <% } %>
            </div>
            <p class="badge-name"><%= b.badge_name %></p>
            <p class="badge-date">Awarded: <%= new Date(b.awarded_at).toLocaleDateString() %></p>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <p>You havenâ€™t earned any badges yet. Keep learning! ğŸš€</p>
    <% } %>
  </div>
</div>


    <div class="analytics-wrapper">
      <div class="analytics-filters">
        <select>
          <option selected>This Week</option>
        </select>
      </div>
      <canvas id="engagementChart"></canvas>
    </div>

    <div class="chart-section">
      <h3>ğŸ“Š Course Completion Progress</h3>
      <canvas id="courseProgressChart"></canvas>
    </div>

    <h2>Continue Learning</h2>
    <div class="course-grid">
      <% enrolledCourses.forEach(course => { %>
      <div class="course-card3">
        <img src="<%= course.thumbnail_url %>" alt="" />
        <div>
          <h4><%= course.title %></h4>
          <p><%= course.progress %>% complete</p>
          <div class="progress-bar">
            <div class="filled" style="width: <%= course.progress %>%"></div>
          </div>
        </div>
      </div>
      <% }) %>
    </div>

  <% } else { %>
    <!-- PATHWAY VIEW -->
    <section class="pathway-section">
      <h2><%= selectedPathway %> Courses</h2>

      <% pathwayCourses[selectedPathway].forEach(course => { %>
      <div class="course-section">
        <h3><%= course.title %></h3>

      <div class="modules-scroll">
  <% (courseModules[course.id] || []).forEach(mod => { %>
    <div class="module-card">
      <img
        style="width: 100%; height: 100px; object-fit: contain"
        src="<%= mod.thumbnail || '/images/JKT logo bg.png' %>"
        alt=""
      />
      <h4 style="font-size: 12px;"><%= mod.title %></h4>
      <p><%= lessonCounts[mod.id] || 0 %> Lessons</p>
       <!-- <a href="/student/dashboard?section=module&moduleId=<%= mod.id %>">View Module</a> -->
          <% if (!mod.unlocked) { %>
            <span class="locked-tag">ğŸ”’ Locked</span>
          <% } else { %>
            <a href="/student/dashboard?section=module&moduleId=<%= mod.id %>">View Module</a>
          <% } %>

      
    </div>
  <% }) %>
</div>


      <% }) %>
    </section>
  <% } %>

  <!-- AI Tutor Widget -->
<style>
  /* MAIN BOX */
  .ai-tutor {
    position: fixed;
    right: 24px;
    bottom: 24px;
    width: 380px;
    max-width: 90vw;
    background: #fff;
    border: 1px solid #eee;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.08);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 9999;
    transition: all 0.3s ease;
  }

  .ai-tutor.fullscreen {
    width: 100vw;
    height: 100vh;
    max-width: 100%;
    max-height: 100%;
    right: 0;
    bottom: 0;
    border-radius: 0;
    z-index: 10000;
  }

  .ai-tutor-header {
    background: #111827;
    color: #fff;
    padding: 10px 14px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .ai-controls {
    display: flex;
    gap: 6px;
  }

  .ai-circle-btn {
    border: none;
    background: transparent;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
  }

  .ai-messages {
    height: 260px;
    overflow-y: auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .ai-msg {
    padding: 10px 12px;
    border-radius: 10px;
    max-width: 85%;
  }

  .ai-msg.user { align-self: flex-end; background: #e5f0ff; }
  .ai-msg.bot { align-self: flex-start; background: #f6f6f6; }

  .ai-input-row {
    display: flex;
    gap: 6px;
    padding: 10px;
    border-top: 1px solid #eee;
  }

  .ai-input-row input {
    flex: 1;
    padding: 8px 10px;
  }

  .ai-input-row button {
    padding: 8px 12px;
    border: none;
    background: #2563eb;
    color: #fff;
    border-radius: 8px;
    cursor: pointer;
  }

  /* FLOATING ICON */
  /* .ai-float {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: #2563eb;
    color: #fff;
    border-radius: 50%;
    width: 56px;
    height: 56px;
    display: none;
    justify-content: center;
    align-items: center;
    font-size: 26px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    cursor: pointer;
    z-index: 9998;
    transition: all 0.3s ease;
  }

  .ai-float:hover {
    transform: scale(1.05);
    background: #1e4ed8;
  } */

  @keyframes breathing {
  0% { transform: scale(1); }
  50% { transform: scale(1.12); }
  100% { transform: scale(1); }
}

@keyframes colorPulse {
  0% { background: #2563eb; }
  50% { background: #1e4ed8; }
  100% { background: #2563eb; }
}

.ai-float {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: #2563eb;
  color: #fff;
  border-radius: 50%;
  width: 56px;
  height: 56px;
  display: none;
  justify-content: center;
  align-items: center;
  font-size: 26px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  cursor: pointer;
  z-index: 9998;
  animation: breathing 2s ease-in-out infinite,
    colorPulse 3s ease-in-out infinite;
  transition: all 0.3s ease;
}
  .ai-float:hover {
    transform: scale(1.05);
    background: #1e4ed8;
  }

  /* COLLAPSED STATE */
  .ai-tutor.collapsed {
    display: none;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const sendBtn = document.getElementById("ai-send");
  const input = document.getElementById("ai-question");
  const messages = document.getElementById("ai-messages");
  const aiTutor = document.getElementById("ai-tutor");
  const aiFloat = document.getElementById("ai-float");
  const toggleBtn = document.getElementById("ai-toggle");
  const fullscreenBtn = document.getElementById("ai-fullscreen");

  // âœ… Push message helper
  function pushMsg(text, who = "user") {
    const msg = document.createElement("div");
    msg.className = "ai-msg " + who;
    msg.innerHTML = text;
    messages.appendChild(msg);
    messages.scrollTop = messages.scrollHeight;
  }

  // âœ… Send message to backend
  async function sendQuestion(q) {
    if (!q.trim()) return;
    // pushMsg(`<p>${q}</p>`, "user");
    // input.value = "";
    const htmlQuestion = marked.parseInline(q);
    pushMsg(htmlQuestion, "user"); // âœ… allows styled question display
    input.value = "";

    try {
      const res = await fetch("/student/ai/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: q, lessonId: window.currentLessonId || null })
      });
      const data = await res.json();
      if (data.ok) {
        const html = marked.parse(data.answer); // âœ… Convert Markdown â†’ HTML
        pushMsg(html, "bot");
      } else {
        pushMsg("<em>âš ï¸ Tutor unavailable.</em>", "bot");
      }
    } catch (err) {
      console.error("AI send error:", err);
      pushMsg("<em>âŒ Error contacting tutor.</em>", "bot");
    }
  }

  sendBtn.onclick = () => sendQuestion(input.value);
  input.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendQuestion(input.value);
    }
  });

  // âœ… Collapse / Expand
  toggleBtn.onclick = () => {
    aiTutor.classList.add("collapsed");
    aiTutor.style.display = "none";
    aiFloat.style.display = "flex"; // show circle
  };

  aiFloat.onclick = () => {
    aiTutor.style.display = "flex";
    aiTutor.classList.remove("collapsed");
    aiFloat.style.display = "none";
  };

  // âœ… Fullscreen toggle
  fullscreenBtn.onclick = () => {
    aiTutor.classList.toggle("fullscreen");
    fullscreenBtn.textContent = aiTutor.classList.contains("fullscreen") ? "ğŸ——" : "â›¶";
  };

  // âœ… Suggested Questions Area
  const suggRow = document.createElement("div");
  suggRow.className = "ai-suggestions";
  aiTutor.querySelector(".ai-input-row").before(suggRow);

  window.showLessonSuggestions = function (suggestions = []) {
    suggRow.innerHTML = "";
    suggestions.forEach((s) => {
      const btn = document.createElement("button");
      btn.className = "sugg-btn";
      btn.textContent = s;
      btn.onclick = () => sendQuestion(s);
      suggRow.appendChild(btn);
    });
  };
});
</script>

</main>

</div>

<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- script to send and receive chat messages -->
<script>
function openChat(teacherId, teacherName) {
  document.getElementById(`chatModal-${teacherId}`).style.display = 'block';
  loadChatMessages(teacherId);
}

function closeChat(teacherId) {
  document.getElementById(`chatModal-${teacherId}`).style.display = 'none';
}

async function sendChat(teacherId) {
  const input = document.getElementById(`chatInput-${teacherId}`);
  const message = input.value.trim();
  if (!message) return;
  input.value = '';

  await fetch(`/student/chat/send`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ receiverId: teacherId, message })
  });

  loadChatMessages(teacherId);
}
async function loadChatMessages(teacherId) {
  const res = await fetch(`/student/chat/messages/${teacherId}`);
  const data = await res.json();
  const container = document.getElementById(`chatMessages-${teacherId}`);

  container.innerHTML = data
    .map(msg => `
      <div class="chat-bubble ${msg.sender === 'self' ? 'self' : 'other'}">
        ${msg.message}
        <small>${new Date(msg.created_at).toLocaleTimeString()}</small>
      </div>
    `)
    .join('');
}


</script>

<!-- styling for AI tutor -->
<style>
.chat-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.5); z-index:1000; }
.chat-content { background:#fff; border-radius:8px; width:400px; max-width:90%; margin:80px auto; padding:15px; position:relative; }
.chat-messages { max-height:300px; overflow-y:auto; border:1px solid #ddd; padding:10px; margin-bottom:10px; }
.chat-bubble { margin:6px 0; padding:8px 10px; border-radius:10px; max-width:70%; }
.chat-bubble.self { background:#e5f0ff; align-self:flex-end; margin-left:auto; }
.chat-bubble.other { background:#f1f1f1; align-self:flex-start; }
.chat-input { display:flex; gap:6px; }
.chat-input input { flex:1; padding:6px 10px; }
.close-chat { position:absolute; top:8px; right:10px; cursor:pointer; font-size:20px; }
</style>

<!-- Badge modal -->
<script>
  function openBadgeModal() {
    document.getElementById("badgeModal").style.display = "block";
  }
  function closeBadgeModal() {
    document.getElementById("badgeModal").style.display = "none";
  }
  window.onclick = function(event) {
    const modal = document.getElementById("badgeModal");
    if (event.target === modal) modal.style.display = "none";
  };
</script>


<!-- Script for engagement char -->
<script>
  const ctx = document.getElementById('engagementChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: <%- JSON.stringify(engagementData.labels) %>,
      datasets: [{
        label: 'Lessons Completed',
        data: <%- JSON.stringify(engagementData.data) %>,
        borderColor: '#2196f3',
        fill: false,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>

<!-- Script for course progress chart -->
<script>
  const ctx2 = document.getElementById('courseProgressChart').getContext('2d');
  const courseProgressChart = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: <%- JSON.stringify(enrolledCourses.map(c => c.title)) %>,
      datasets: [{
        label: 'Progress (%)',
        data: <%- JSON.stringify(enrolledCourses.map(c => c.progress)) %>,
        backgroundColor: [
          '#4CAF50',
          '#2196F3',
          '#FFC107',
          '#FF5722',
          '#9C27B0',
          '#3F51B5',
          '#E91E63',
          '#00BCD4',
          '#8BC34A',
          '#FF9800'
        ],
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Completion (%)'
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.parsed.y}% completed`;
            }
          }
        }
      }
    }
  });
</script>

<!-- Script for sidebar -->
<script>
  document.querySelectorAll(".dropdown-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      this.classList.toggle("active");
      const dropdown = this.nextElementSibling;
      dropdown.style.display =
        dropdown.style.display === "block" ? "none" : "block";
    });
  });

  document.querySelectorAll(".sub-dropdown-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      this.classList.toggle("active");
      const sub = this.nextElementSibling;
      sub.style.display = sub.style.display === "block" ? "none" : "block";
    });
  });
</script>

<!-- script to Highlight active navbar -->
<script>
  const tabs = document.querySelectorAll(".nav-tab");
  tabs.forEach((tab) => {
    if (tab.href === window.location.href) {
      tab.classList.add("active");
    }
  });
  document
    .getElementById("toggleSidebar")
    .addEventListener("click", function () {
      document.querySelector(".sidebar").classList.toggle("open");
    });
</script>

<!-- script for edit modal -->
 <script>
  function openEditModal(id) {
    document.getElementById("editModal-" + id).style.display = "block";
  }

  function closeEditModal(id) {
    document.getElementById("editModal-" + id).style.display = "none";
  }
</script>

<!-- Lesson and quiz script -->
 
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const sendBtn = document.getElementById("ai-send");
  const input = document.getElementById("ai-question");
  const messages = document.getElementById("ai-messages");

  // helper: render message (âœ… allow HTML so answers can be styled)
  function pushMsg(text, who = "user") {
    const msg = document.createElement("div");
    msg.className = "msg " + who;
    msg.innerHTML = text; // âœ… allow headings, lists, code
    messages.appendChild(msg);
    messages.scrollTop = messages.scrollHeight;
  }

  // handle sending
  async function sendQuestion(q) {
    if (!q.trim()) return;

    pushMsg(`<p>${q}</p>`, "user"); // show immediately
    input.value = "";

    try {
      const res = await fetch("/student/ai/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          question: q,
          lessonId: window.currentLessonId || null
        })
      });
      const data = await res.json();
      if (data.ok) {
        const html = marked.parse(data.answer); // âœ… Convert Markdown â†’ HTML
        pushMsg(html, "bot");
      } else {
        pushMsg("<em>âš ï¸ Tutor is unavailable.</em>", "bot");
      }
    } catch (err) {
      console.error("AI send error:", err);
      pushMsg("<em>âŒ Error contacting tutor.</em>", "bot");
    }
  }

  // click send
  sendBtn.addEventListener("click", () => sendQuestion(input.value));

  // press Enter
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendQuestion(input.value);
    }
  });

  // âœ… Suggested questions buttons
  const suggRow = document.createElement("div");
  suggRow.className = "ai-suggestions";
  document.querySelector("#ai-tutor .ai-input-row").before(suggRow);

  window.showLessonSuggestions = function (suggestions = []) {
    suggRow.innerHTML = ""; // clear old
    suggestions.forEach((s) => {
      const btn = document.createElement("button");
      btn.className = "sugg-btn";
      btn.innerText = s;
      btn.onclick = () => sendQuestion(s);
      suggRow.appendChild(btn);
    });
  };

  // âœ… Collapse/expand chatbox
  const aiTutor = document.getElementById("ai-tutor");
  const aiMessages = document.getElementById("ai-messages");
  const toggleBtn = document.getElementById("ai-toggle");

  toggleBtn.addEventListener("click", () => {
    if (aiTutor.classList.contains("collapsed")) {
      aiTutor.classList.remove("collapsed");
      aiMessages.style.display = "block";
      document.querySelector("#ai-tutor .ai-input-row").style.display = "flex";
      suggRow.style.display = "flex";
      toggleBtn.textContent = "â€“";
    } else {
      aiTutor.classList.add("collapsed");
      aiMessages.style.display = "none";
      document.querySelector("#ai-tutor .ai-input-row").style.display = "none";
      suggRow.style.display = "none";
      toggleBtn.textContent = "+";
    }
  });
});
</script>

<!-- script for loading lesson content and assignment loading and submission review -->
<script>
  function toggleModule(moduleId) {
    const el = document.getElementById(`module-${moduleId}`);
    el.style.display = (el.style.display === "none" || !el.style.display) ? "block" : "none";
  }

  // function toggleLessonMenu(lessonId) {
  //   const menu = document.getElementById("lesson-menu-" + lessonId);
  //   if (!menu) return;
  //   // Toggle display
  //   if (menu.style.display === "none" || menu.style.display === "") {
  //     menu.style.display = "block";
  //   } else {
  //     menu.style.display = "none";
  //   }
  // }

  function handleLessonClick(lessonId, unlocked) {
    if (!unlocked) {
      alert("This lesson is locked. Complete previous lessons first.");
      return;
    }
    toggleLessonMenu(lessonId);
  }

  function toggleLessonMenu(lessonId) {
    const menu = document.getElementById("lesson-menu-" + lessonId);
    if (!menu) return;
    menu.style.display = (menu.style.display === "none" || !menu.style.display) ? "block" : "none";
  }

  function loadLessonPart(lessonId, part) {
    showLoading();
    fetch(`/student/lessons/${lessonId}`)
      .then(res => res.json())
      .then(lesson => {
        window.currentLessonId = lessonId; // âœ… Keep track
        let html = `<h2>${lesson.title}</h2>`;

        // ğŸ¥ VIDEO SECTION
        if (part === "video" && lesson.video_url) {
          let embedUrl = lesson.video_url.trim();

          if (embedUrl.includes("youtube.com/watch?v=")) {
            const videoId = embedUrl.split("v=")[1].split("&")[0];
            embedUrl = `https://www.youtube.com/embed/${videoId}`;
          } else if (embedUrl.includes("youtu.be/")) {
            const videoId = embedUrl.split("youtu.be/")[1].split("?")[0];
            embedUrl = `https://www.youtube.com/embed/${videoId}`;
          } else if (embedUrl.includes("vimeo.com/")) {
            const videoId = embedUrl.split("vimeo.com/")[1].split("?")[0];
            embedUrl = `https://player.vimeo.com/video/${videoId}`;
          }

          html += `
            <div class="lesson-video">
              <iframe 
                src="${embedUrl}" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
              </iframe>
            </div>
          `;

          document.getElementById("lessonMainArea").innerHTML = html;
          document.getElementById("ai-tutor").style.display = "none";
          hideLoading();
          return;
        }

        // ğŸ“ LESSON NOTE + SLIDES SECTION
      if (part === "content") {
    const rawContent = lesson.content || "<p>No content available.</p>";

    // âœ… Split slides automatically by emojis, <hr>, or ---
    const slideBreaks = /(<hr\s*\/?>|---)/gi;

    // Split and clean
    // const rawSlides = rawContent
    //   .split(slideBreaks)
    //   .map(s => s.trim())
    //   .filter(s => s && s !== "<hr>" && s !== "<hr/>" && s !== "---");
    const rawSlides = rawContent
    .split(slideBreaks)
    .map(s => s.trim())
    .filter(s => {
      // Remove empty, HR-only, or image-only fragments
      const clean = s.replace(/<img[^>]*>/g, '').replace(/<[^>]+>/g, '').trim();
      return clean.length > 0 && !/^(-{3,}|<hr\s*\/?>)$/i.test(s);
    });


    // âœ… Build slide objects with titles and content
    const slides = rawSlides.map((s, index) => {
      // Try to extract the first bold text or first sentence as title
      let title = "";

      // Match first <strong> or <b> text
      const boldMatch = s.match(/<strong>(.*?)<\/strong>|<b>(.*?)<\/b>/i);
      if (boldMatch) {
        title = boldMatch[1] || boldMatch[2];
      } else {
        // Fallback: use first few words
        const plain = s.replace(/<[^>]+>/g, "").trim();
        title = plain.split(/\s+/).slice(0, 5).join(" ") + "...";
      }

      return { title, body: s };
    });

    // âœ… Build HTML structure
    // const noteView = `
    //   <div class="lesson-view-mode">
    //     <button id="noteBtn" class="active">ğŸ“ Note View</button>
    //     <button id="slideBtn">ğŸ“‘ Slides View</button>
    //   </div>
    //   <div id="noteView" class="lesson-note">${rawContent}</div>
    //   <div id="slideView" class="lesson-slides" style="display:none;"></div>
    // `;
    const noteView = `
    <div class="lesson-view-controls">
      <div class="text-controls">
        <label>Text size:</label>
        <button id="fontInc">A+</button>
        <button id="fontDec">Aâˆ’</button>

        <label>Font:</label>
        <select id="fontSelect">
          <option value="system-ui">Default</option>
          <option value="serif">Serif</option>
          <option value="sans-serif">Sans-serif</option>
          <option value="OpenDyslexic, Arial">Dyslexic</option>
        </select>

        <label>Line spacing:</label>
        <select id="lineSpacing">
          <option value="1.4">Normal</option>
          <option value="1.8">Comfort</option>
          <option value="2.2">Wide</option>
        </select>
      </div>

      <div class="lesson-view-mode">
        <button id="noteBtn" class="active">ğŸ“ Note View</button>
        <button id="slideBtn">ğŸ“‘ Slides View</button>
      </div>
    </div>

    <div id="noteView" class="lesson-note">${rawContent}</div>
    <div id="slideView" class="lesson-slides" style="display:none;"></div>
  `;


    document.getElementById("lessonMainArea").innerHTML = noteView;

    // âœ… Render slides
    let current = 0;
    function renderSlide() {
      const total = slides.length;
      const { title, body } = slides[current];

      const html = `
        <div class="slide-box">
          <div class="slide-body">${body}</div>
          <div class="slide-controls">
            <button id="prevSlide" ${current === 0 ? "disabled" : ""}>â¬… Prev</button>
            <span>Slide ${current + 1} of ${total}</span>
            <button id="nextSlide" ${current === total - 1 ? "disabled" : ""}>Next â¡</button>
            <button id="fullscreenBtn" class="fullscreen-btn" title="Toggle Fullscreen">â›¶</button>
          </div>
        </div>
      `;

      document.getElementById("slideView").innerHTML = html;
      document.getElementById("fullscreenBtn").onclick = toggleFullscreen;
      document.getElementById("prevSlide").onclick = () => {
        if (current > 0) { current--; renderSlide(); }
      };
      document.getElementById("nextSlide").onclick = () => {
        if (current < total - 1) { current++; renderSlide(); }
      };
    }

    // âœ… Add fullscreen toggle support
  // function toggleFullscreen() {
  //   const slideView = document.getElementById("slideView");
  //   if (!document.fullscreenElement) {
  //     slideView.requestFullscreen().catch(err => {
  //       console.error("Fullscreen error:", err);
  //     });
  //   } else {
  //     document.exitFullscreen();
  //   }
  // }

  /* ==============================
    ğŸ”¹ FULLSCREEN + KEYBOARD CONTROLS
    ============================== */

  // Track fullscreen state
  function toggleFullscreen() {
    const slideView = document.getElementById("slideView");
    if (!document.fullscreenElement) {
      slideView.requestFullscreen().catch(err => {
        console.error("Fullscreen error:", err);
        alert("Your browser doesn't support fullscreen mode.");
      });
    } else {
      document.exitFullscreen();
    }
  }

  // ğŸ”¸ Default font size
  let fontSize = 16;

  // ğŸ”¸ Adjust font size dynamically
  function adjustFont(delta) {
    fontSize = Math.min(26, Math.max(12, fontSize + delta));
    const slideBody = document.querySelector(".slide-body");
    if (slideBody) slideBody.style.fontSize = fontSize + "px";
  }

  // ğŸ”¸ Dark mode toggle
  let darkMode = false;
  function toggleDarkMode() {
    const slideBox = document.querySelector(".slide-box");
    if (!slideBox) return;
    darkMode = !darkMode;

    if (darkMode) {
      slideBox.style.background = "#111";
      slideBox.style.color = "#fff";
    } else {
      slideBox.style.background = "#fff";
      slideBox.style.color = "#111";
    }
  }

  // ğŸ”¸ Auto-play toggle
  let autoPlay = null;
  function toggleAutoPlay() {
    if (autoPlay) {
      clearInterval(autoPlay);
      autoPlay = null;
      showToast("â¸ Auto-play stopped");
    } else {
      autoPlay = setInterval(() => {
        document.getElementById("nextSlide")?.click();
      }, 5000); // every 5 seconds
      showToast("â–¶ï¸ Auto-play started");
    }
  }

  // ğŸ”¸ Toast notification for feedback
  function showToast(message) {
    let toast = document.createElement("div");
    toast.textContent = message;
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.right = "20px";
    toast.style.background = "rgba(0,0,0,0.7)";
    toast.style.color = "#fff";
    toast.style.padding = "10px 14px";
    toast.style.borderRadius = "6px";
    toast.style.zIndex = "99999";
    toast.style.fontSize = "14px";
    toast.style.transition = "opacity 0.3s";
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = "0"; }, 2000);
    setTimeout(() => { toast.remove(); }, 2500);
  }

  // ğŸ”¸ Keyboard shortcuts while in fullscreen
  document.addEventListener("keydown", (e) => {
    if (!document.fullscreenElement) return; // only works in fullscreen

    switch (e.key.toLowerCase()) {
      case "arrowright":
      case "d":
        document.getElementById("nextSlide")?.click();
        break;
      case "arrowleft":
      case "a":
        document.getElementById("prevSlide")?.click();
        break;
      case "f":
        toggleFullscreen();
        break;
      case "escape":
        document.exitFullscreen();
        break;
      case "+":
        adjustFont(1);
        break;
      case "-":
        adjustFont(-1);
        break;
      case "0":
        fontSize = 17;
        const body = document.querySelector(".slide-body");
        if (body) body.style.fontSize = "17px";
        break;
      case "p":
        toggleAutoPlay();
        break;
      case "m":
        toggleDarkMode();
        break;
    }
  });



    renderSlide();
    // âœ… Text Controls
  // let fontSize = 16; // default

  function applyTextStyles() {
    const font = document.getElementById("fontSelect").value;
    const spacing = document.getElementById("lineSpacing").value;
    document.querySelectorAll(".lesson-note, .slide-body").forEach(el => {
      el.style.fontSize = fontSize + "px";
      el.style.fontFamily = font;
      el.style.lineHeight = spacing;
    });
  }

  document.getElementById("fontInc").onclick = () => {
    fontSize += 2;
    applyTextStyles();
  };

  document.getElementById("fontDec").onclick = () => {
    if (fontSize > 10) fontSize -= 2;
    applyTextStyles();
  };

  document.getElementById("fontSelect").onchange = applyTextStyles;
  document.getElementById("lineSpacing").onchange = applyTextStyles;


    // âœ… Toggle Note / Slide views
    const noteBtn = document.getElementById("noteBtn");
    const slideBtn = document.getElementById("slideBtn");
    const noteDiv = document.getElementById("noteView");
    const slideDiv = document.getElementById("slideView");

    noteBtn.onclick = () => {
      noteDiv.style.display = "block";
      slideDiv.style.display = "none";
      noteBtn.classList.add("active");
      slideBtn.classList.remove("active");
    };

    slideBtn.onclick = () => {
      noteDiv.style.display = "none";
      slideDiv.style.display = "block";
      slideBtn.classList.add("active");
      noteBtn.classList.remove("active");
    };

    // document.getElementById("ai-tutor").style.display = "flex";
    document.getElementById("ai-tutor").style.display = "none";
    document.getElementById("ai-float").style.display = "flex";

    // âœ… Suggest questions
    const suggestions = [
      `Summarize this lesson in simple terms.`,
      `What is the key concept in "${lesson.title}"?`,
      `Can you give me an example based on this lesson?`
    ];
    if (window.showLessonSuggestions) {
      window.showLessonSuggestions(suggestions);
    }
    hideLoading();
    return;
  }

        // ğŸ§© QUIZ SECTION
        if (part === "quiz") {
          loadQuizInline(lessonId);
          document.getElementById("ai-tutor").style.display = "none";
          hideLoading();
          return;
        }
      })
      .catch(err => {
        console.error("Error loading lesson:", err);
        document.getElementById("lessonMainArea").innerHTML = "<p>âš ï¸ Failed to load lesson.</p>";
        hideLoading();
      });
  }


  function loadQuizInMain(lessonId) {
    showLoading();
    fetch(`/student/lessons/${lessonId}/quiz`)
      .then(res => res.json())
      .then(data => {
        let html = `<h2>Lesson Quiz</h2>`;
        if (!data.success) {
          html += `<p>No quiz for this lesson.</p>`;
        } else {
          html += `<form onsubmit="submitQuizInline(event, ${lessonId})">`;
          data.questions.forEach((q, idx) => {
            html += `<p><strong>Q${idx+1}:</strong> ${q.question}</p>`;
            q.options.forEach(opt => {
              html += `<label><input type="radio" name="q${q.id}" value="${opt}" required> ${opt}</label><br>`;
            });
          });
          html += `<button type="submit">Submit Quiz</button></form>`;
        }
        document.getElementById("lessonMainArea").innerHTML = html;
      })
      .catch(err => {
        hideLoading(); // â— Hide even on error
        console.error(err);
      });
  }


  async function loadAssignment(assignmentId) {
    showLoading();
    try {
      const res = await fetch(`/student/assignments/${assignmentId}`);
      if (!res.ok) {
        const text = await res.text();
        console.error("Assignment fetch failed:", text);
        alert("Could not load assignment");
        return;
      }
      const data = await res.json();

      const lessonMain = document.getElementById("lessonMainArea");

      if (data.submitted) {
        // âœ… Show previous submission with breakdown
        const criteriaHTML = data.submission.criteria
          ? Object.entries(data.submission.criteria)
              .map(([crit, score]) => `<p>${crit}: <strong>${score}</strong></p>`)
              .join("")
          : "<p>No detailed breakdown.</p>";

        lessonMain.innerHTML = `
          <div class="assignment-container" style="border:1px solid #ccc; padding:15px; border-radius:8px; max-width:600px;">
            <h2>ğŸ“‘ ${data.assignment.title}</h2>
            <p><strong>Course:</strong> ${data.assignment.course_title}</p>
            <p><strong>Module:</strong> ${data.assignment.module_title}</p>
            <hr>
            <h3>âœ… You already submitted this assignment</h3>
            <p><strong>Description:</strong> ${data.submission.description}</p>
            ${data.submission.file_url ? `<p><a href="${data.submission.file_url}" target="_blank">ğŸ“‚ View File</a></p>` : ""}
            <h3>ğŸ“Š AI Feedback</h3>
            <p><strong>Total Score:</strong> ${data.submission.total ?? "Pending"}</p>
            <p><strong>Grade:</strong> ${data.submission.grade ?? "N/A"}</p>
            <div><strong>Criteria Breakdown:</strong>${criteriaHTML}</div>
            <div><strong>Comments:</strong><p>${data.submission.ai_feedback ?? "Pending"}</p></div>
          </div>
        `;
        hideLoading();
        return;
      } else {
        // âœ… Show form if not yet submitted
        lessonMain.innerHTML = `
          <div class="assignment-container" style="border:1px solid #ccc; padding:15px; border-radius:8px; max-width:600px;">
            <h2>ğŸ“‘ ${data.assignment.title}</h2>
            <p><strong>Course:</strong> ${data.assignment.course_title}</p>
            <p><strong>Module:</strong> ${data.assignment.module_title}</p>
            <div class="instructions">
              <strong>Instructions:</strong>
              <p>${data.assignment.instructions}</p>
            </div>
            <p><strong>Due Date:</strong> ${data.assignment.due_date || "No due date"}</p>

            <h3>Submit Your Work</h3>
            <form id="submitAssignmentForm" enctype="multipart/form-data">
              <input type="hidden" name="assignmentId" value="${assignmentId}" />
              <label>Description:</label><br>
              <textarea id="assignmentDescription" name="description" placeholder="Write your answer..." required></textarea><br><br>
              <label>Upload File (optional):</label>
              <input type="file" name="file"><br><br>
              <button type="submit">Submit Assignment</button>
            </form>
          </div>
        `;
        // ğŸŸ¢ Initialize CKEditor for assignment submission
        setTimeout(() => {
          if (CKEDITOR.instances.assignmentDescription) {
            CKEDITOR.instances.assignmentDescription.destroy(true);
          }
          CKEDITOR.replace("assignmentDescription");
        }, 50);


        hideLoading();

        // âœ… Attach submit handler
        document.getElementById("submitAssignmentForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            // â­ VERY IMPORTANT â€” Update CKEditor content into textarea
            if (CKEDITOR.instances.assignmentDescription) {
              CKEDITOR.instances.assignmentDescription.updateElement();
            }
            showLoading();  // ğŸŸ¡ Loader during submission
            const formData = new FormData(e.target);

            const res2 = await fetch(`/student/assignments/${assignmentId}/submit`, {
              method: "POST",
              body: formData
            });

            const result = await res2.json();
             hideLoading(); // ğŸŸ¢ Hide once submitted

            if (result.success) {
              const criteriaHTML = result.criteria
                ? Object.entries(result.criteria)
                    .map(([crit, score]) => `<p>${crit}: <strong>${score}</strong></p>`)
                    .join("")
                : "<p>No detailed breakdown.</p>";

              lessonMain.innerHTML = `
                <div class="assignment-container" style="border:1px solid #ccc; padding:15px; border-radius:8px; max-width:600px;">
                  <h2>âœ… Assignment Submitted Successfully!</h2>
                  <p><strong>Assignment:</strong> ${data.assignment.title}</p>
                  <p><strong>Status:</strong> Graded by AI</p>
                  <hr>
                  <h3>ğŸ“Š AI Feedback</h3>
                  <div class="feedback-box">
                    <p><strong>Total Score:</strong> ${result.total ?? "Pending"}</p>
                    <p><strong>Grade:</strong> ${result.grade ?? "N/A"}</p>
                    <div><strong>Criteria Breakdown:</strong>${criteriaHTML}</div>
                    <div><strong>Comments:</strong><p>${result.feedbackText ?? "Feedback not available yet."}</p></div>
                  </div>
                </div>
              `;
            } else {
              alert(result.message || "âŒ Submission failed.");
            }
          });
      }

    } catch (err) {
      hideLoading();
      console.error("Error loading assignment:", err);
      alert("Could not load assignment");
    }
  }


  document.addEventListener("DOMContentLoaded", () => {
    // Assignment button event binding
    document.querySelectorAll(".assignment-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = Number(btn.dataset.id);
        if (!isNaN(id)) {
          loadAssignment(id);
        } else {
          console.error("Invalid assignment id:", btn.dataset.id);
        }
      });
    });
  });

  async function loadPastSubmissions() {
    showLoading();
    try {
      const res = await fetch("/student/assignments/mine");
      const data = await res.json();
      if (!data.success) {
        alert(data.message || "Could not load submissions");
        return;
      }

      const lessonMain = document.getElementById("lessonMainArea");
      lessonMain.innerHTML = `
        <h2>ğŸ“š My Assignment Submissions</h2>
        <div class="submissions-list">
          ${data.submissions.map(s => {
            // const criteriaHTML = s.criteria
            //   ? Object.entries(s.criteria)
            //       .map(([crit, score]) => `<p>${crit}: <strong>${score}</strong></p>`)
            //       .join("")
            //   : "<p>No detailed breakdown.</p>";
            const criteriaData = s.criteria 
              ? (typeof s.criteria === "string" ? JSON.parse(s.criteria) : s.criteria) 
              : null;

            const criteriaHTML = criteriaData
              ? Object.entries(criteriaData)
                  .map(([crit, score]) => `<p>${crit}: <strong>${score}</strong></p>`)
                  .join("")
              : "<p>No detailed breakdown.</p>";

            return `
              <div class="submission-card" style="border:1px solid #ccc; padding:10px; margin-bottom:10px; width:50%;">
                <h3>${s.assignment_title}</h3>
                <p><strong>Course:</strong> ${s.course_title}</p>
                <p><strong>Module:</strong> ${s.module_title}</p>
                <p><strong>Submitted:</strong> ${new Date(s.submitted_at).toLocaleString()}</p>
                <p><strong>Total Score:</strong> ${s.total ?? "Not graded yet"}</p>
                <p><strong>Grade:</strong> ${s.grade ?? "-"}</p>
                <div><strong>Criteria Breakdown:</strong>${criteriaHTML}</div>
                <p><strong>Feedback:</strong> ${s.ai_feedback ?? "Not graded yet"}</p>
                <button onclick="reviewSubmission(${s.id})">ğŸ” Review</button>
              </div>
            `;
          }).join("")}
        </div>
      `;
    } catch (err) {
      console.error("Error loading past submissions:", err);
      alert("Could not load past submissions");
    }
  }

  async function reviewSubmission(subId) {
    showLoading();
    try {
      const res = await fetch(`/student/assignments/submission/${subId}`);
      const data = await res.json();
      if (!data.success) {
        alert(data.message || "Could not load submission");
        return;
      }

      const s = data.submission;

      // const criteriaHTML = s.criteria
      //   ? Object.entries(s.criteria)
      //       .map(([crit, score]) => `<p>${crit}: <strong>${score}</strong></p>`)
      //       .join("")
      //   : "<p>No detailed breakdown.</p>";

      const criteriaData = s.criteria 
        ? (typeof s.criteria === "string" ? JSON.parse(s.criteria) : s.criteria) 
        : null;

      const criteriaHTML = criteriaData
        ? Object.entries(criteriaData)
            .map(([crit, score]) => `<p>${crit}: <strong>${score}</strong></p>`)
            .join("")
        : "<p>No detailed breakdown.</p>";

      const lessonMain = document.getElementById("lessonMainArea");
      lessonMain.innerHTML = `
        <div class="submission-review" style="border:1px solid #ccc; padding:15px; border-radius:8px; max-width:600px;">
          <h2>ğŸ“ ${s.assignment_title}</h2>
          <p><strong>Instructions:</strong> ${s.instructions}</p>
          <p><strong>Your Answer:</strong> ${s.description}</p>
          ${s.file_url ? `<p><a href="${s.file_url}" target="_blank">ğŸ“‚ View File</a></p>` : ""}

          <h3>âœ… AI Feedback</h3>
          <p><strong>Total Score:</strong> ${s.total ?? "Pending"}</p>
          <p><strong>Grade:</strong> ${s.grade ?? "-"}</p>
          <div><strong>Criteria Breakdown:</strong>${criteriaHTML}</div>
          <div class="ai-feedback-box"><strong>Comments:</strong> ${s.ai_feedback ?? "Not graded yet"}</div>

          <button onclick="loadPastSubmissions()">â¬… Back to Submissions</button>
        </div>
      `;
    } catch (err) {
      console.error("Error reviewing submission:", err);
      alert("Could not review submission");
    }
  }

</script>

<script src="https://cdn.ckeditor.com/4.22.1/full/ckeditor.js"></script>


<!-- script for loading, submiting reviewing quiz -->
<script>
  function toggleModule(moduleId) {
    const el = document.getElementById(`module-${moduleId}`);
    el.style.display = (el.style.display === "none" || !el.style.display) ? "block" : "none";
  }

  // function toggleLesson(lessonId) {
  //   const el = document.getElementById(`lesson-expand-${lessonId}`);
  //   if (el.style.display === "block") {
  //     el.style.display = "none";
  //     return;
  //   }
  //   // Load lesson details
  //   fetch(`/student/lessons/${lessonId}`)
  //     .then(res => res.json())
  //     .then(lesson => {
  //       let html = "";
  //       if (lesson.video_url) {
  //         html += `<div class="lesson-video">
  //           <iframe src="${lesson.video_url}" frameborder="0" allowfullscreen></iframe>
  //         </div>`;
  //       }
  //       html += `<div class="lesson-text">${lesson.content || '<p>No content available.</p>'}</div>`;
  //       if (lesson.has_quiz) {
  //         html += `<button class="btn-quiz" onclick="loadQuizInline(${lesson.id})">Take Quiz</button>
  //                 <div id="quiz-area-${lesson.id}" class="quiz-inline"></div>`;
  //       }
  //       el.innerHTML = html;
  //       el.style.display = "block";
  //     });
  // }


  function loadQuizInline(lessonId) {
    showLoading();
    fetch(`/student/lessons/${lessonId}/quiz`)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("lessonMainArea");

        if (!data.success) {
          container.innerHTML = "<p>No quiz available.</p>";
          return;
        }

        // âœ… If already submitted, show review
        if (data.alreadySubmitted) {
          window.quizReviewData = Array.isArray(data.reviewData)
            ? data.reviewData
            : [];

          window.currentReviewLesson = lessonId;

          container.innerHTML = `
            <h3>ğŸ“Š Quiz Results</h3>
            <p><strong>Score:</strong> ${data.score}%</p>
            <p><strong>Status:</strong> ${data.passed ? "âœ… Passed" : "âŒ Failed"}</p>
            <div class="ai-feedback">
              <strong>ğŸ¤– AI Feedback Summary:</strong> ${data.feedback || "No feedback available"}
            </div>
            <hr>
            <h3>Detailed Review</h3>
            <div id="quiz-review-${lessonId}"></div>
            <button onclick="loadLessonPart(${lessonId}, 'content')">â¬… Back to Lesson</button>
          `;

          // Render review if available
          if (window.quizReviewData.length > 0) {
            reviewQuizInline(lessonId);
          } else {
            document.getElementById(`quiz-review-${lessonId}`).innerHTML =
              "<p>No detailed review available.</p>";
          }

          return; // ğŸš€ stop here
        }

        // âœ… Otherwise, render quiz form
        const questions = Array.isArray(data.questions) ? data.questions : [];
        if (questions.length === 0) {
          container.innerHTML = "<p>No quiz questions available.</p>";
          return;
        }

        let quizHTML = `<form onsubmit="submitQuizInline(event, ${lessonId})">`;

        questions.forEach((q, i) => {
          quizHTML += `
            <div class="quiz-question" style="margin-bottom:15px;">
              <p><strong>Q${i + 1}:</strong> ${q.question}</p>
              ${q.options
                .map(
                  opt => `
                  <label>
                    <input type="radio" name="q${q.id}" value="${opt}" required>
                    ${opt}
                  </label><br>
                `
                )
                .join("")}
            </div>
          `;
        });

        quizHTML += `<button type="submit">Submit Quiz</button></form>`;
        container.innerHTML = `<div id="quiz-area-${lessonId}">${quizHTML}</div>`;
      })
      
      .catch(err => {
        console.error("âŒ loadQuizInline error:", err);
        document.getElementById("lessonMainArea").innerHTML =
          "<p>Error loading quiz.</p>";
      });

  }


  // function submitQuizInline(e, lessonId) {
  //   e.preventDefault();
  //    showLoading(); // â¬…ï¸ Start loading animation

  //   const formData = new FormData(e.target);
  //   const answers = {};
  //   for (let [key, value] of formData.entries()) {
  //     answers[key] = value;
  //   }

  //   fetch(`/student/lessons/${lessonId}/quiz/submit`, {
  //     method: "POST",
  //     headers: { "Content-Type": "application/json" },
  //     body: JSON.stringify({
  //       lessonId: lessonId,  // âœ… backend uses this to lookup quizId
  //       answers: answers
  //     })
  //   })
  //     .then(res => res.json())
  //     .then(result => {
  //       const quizContainer = document.getElementById(`quiz-area-${lessonId}`) || document.getElementById("lessonMainArea");

  //       if (!result.success) {
  //         quizContainer.innerHTML = `<p class="error">âŒ Quiz submission failed. ${result.message || ""}</p>`;
  //         return;
  //       }

  //       // Save review data globally
  //       window.quizReviewData = result.reviewData;
  //       window.currentReviewLesson = lessonId;

  //       quizContainer.innerHTML = `
  //         <h3>Quiz Results</h3>
  //         <p><strong>Score:</strong> ${result.score}%</p>
  //         <p><strong>Status:</strong> ${result.passed ? "âœ… Passed" : "âŒ Failed"}</p>
  //         <div class="ai-feedback"><strong>ğŸ¤– AI Feedback Summary:</strong> ${result.feedback}</div>
  //         <hr>
  //         <h3>Detailed Review</h3>
  //         <div id="quiz-review-${lessonId}"></div>
  //         <button onclick="loadLessonPart(${lessonId}, 'content')">â¬… Back to Lesson</button>
  //       `;

  //       reviewQuizInline(lessonId); // show detailed review
  //       // ğŸš€ If passed, unlock the next lesson in the UI
  //       if (result.passed) {
  //         const nextLessonBtn = document.querySelector(
  //           `#lesson-btn-${lessonId + 1}` // adjust if your button IDs differ
  //         );
  //         if (nextLessonBtn) {
  //           nextLessonBtn.removeAttribute("disabled");
  //           nextLessonBtn.style.opacity = "1";
  //           nextLessonBtn.style.cursor = "pointer";
  //         }
  //       }
  //       if (result.feedback) {
  //         pushMsg("AI Quiz Feedback: " + result.feedback, "bot");
  //       }
  //     })
  //     .catch(err => {
  //       hideLoading(); // â¬…ï¸ Stop animation even on error
  //       console.error("âŒ Error submitting quiz:", err);
  //       const quizContainer = document.getElementById(`quiz-area-${lessonId}`) || document.getElementById("lessonMainArea");
  //       quizContainer.innerHTML = `<p class="error">Error submitting quiz. Please try again.</p>`;
  //     });
  // }
  

  function submitQuizInline(e, lessonId) {
  e.preventDefault();
  showLoading(); // â¬…ï¸ Start loading animation

  const formData = new FormData(e.target);
  const answers = {};
  for (let [key, value] of formData.entries()) {
    answers[key] = value;
  }

  fetch(`/student/lessons/${lessonId}/quiz/submit`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      lessonId: lessonId,
      answers: answers
    })
  })
    .then(res => {
      if (!res.ok) {
        throw new Error("Server did not respond correctly.");
      }
      return res.json();
    })
    .then(result => {
      // â­ Small delay ensures backend finishes grading before displaying
      return new Promise(resolve => setTimeout(() => resolve(result), 300));
    })
    .then(result => {
      hideLoading(); // â¬…ï¸ Stop loading animation

      const quizContainer =
        document.getElementById(`quiz-area-${lessonId}`) ||
        document.getElementById("lessonMainArea");

      if (!result.success) {
        quizContainer.innerHTML =
          `<p class="error">âŒ Quiz submission failed. ${result.message || ""}</p>`;
        return;
      }

      // Save review data globally
      window.quizReviewData = result.reviewData;
      window.currentReviewLesson = lessonId;

      quizContainer.innerHTML = `
        <h3>Quiz Results</h3>
        <p><strong>Score:</strong> ${result.score}%</p>
        <p><strong>Status:</strong> ${result.passed ? "âœ… Passed" : "âŒ Failed"}</p>
        <div class="ai-feedback"><strong>ğŸ¤– AI Feedback Summary:</strong> ${result.feedback}</div>
        <hr>
        <h3>Detailed Review</h3>
        <div id="quiz-review-${lessonId}"></div>
        <button onclick="loadLessonPart(${lessonId}, 'content')">â¬… Back to Lesson</button>
      `;

      reviewQuizInline(lessonId);

      // ğŸš€ Unlock next lesson if passed
      if (result.passed) {
        const nextLessonBtn = document.querySelector(
          `#lesson-btn-${lessonId + 1}`
        );

        if (nextLessonBtn) {
          nextLessonBtn.removeAttribute("disabled");
          nextLessonBtn.style.opacity = "1";
          nextLessonBtn.style.cursor = "pointer";
        }
      }

      if (result.feedback) {
        pushMsg("AI Quiz Feedback: " + result.feedback, "bot");
      }
    })
    .catch(err => {
      hideLoading(); // â¬…ï¸ Make sure spinner stops
      console.error("âŒ Error submitting quiz:", err);

      const quizContainer =
        document.getElementById(`quiz-area-${lessonId}`) ||
        document.getElementById("lessonMainArea");

      quizContainer.innerHTML =
        `<p class="error">Error submitting quiz. Please try again.</p>`;
    });
}


  function reviewQuizInline(lessonId) {
    if (!window.quizReviewData || !Array.isArray(window.quizReviewData) || window.quizReviewData.length === 0) {
      alert("No review data available.");
      return;
    }

    // âœ… Calculate summary
    let totalQuestions = window.quizReviewData.length;
    let correctCount = window.quizReviewData.filter(q => q.isCorrect).length;
    let score = Math.round((correctCount / totalQuestions) * 100);
    let passed = score >= 50;

    // âœ… Build summary card
    let reviewHTML = `
      <h3>ğŸ“– Quiz Review</h3>
      <div style="background:#f9f9f9; border:2px solid ${passed ? '#4CAF50' : '#f44336'};
                  padding:15px; border-radius:8px; margin-bottom:20px; max-width:600px;">
        <p><strong>Total Questions:</strong> ${totalQuestions}</p>
        <p><strong>Correct Answers:</strong> ${correctCount}</p>
        <p><strong>Score:</strong> ${score}%</p>
        <p><strong>Status:</strong> 
          <span style="font-weight:bold; color:${passed ? '#4CAF50' : '#f44336'};">
            ${passed ? "âœ… Passed" : "âŒ Failed"}
          </span>
        </p>
      </div>
    `;

    // âœ… Then per-question breakdown
    window.quizReviewData.forEach((q, idx) => {
      reviewHTML += `
        <div class="review-question" 
            style="border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:5px; max-width:600px;">
          <p><strong>Q${idx + 1}:</strong> ${q.question}</p>
          <p><strong>Your Answer:</strong> ${q.yourAnswer || "No answer"}</p>
          <p><strong>Correct Answer:</strong> ${q.correctAnswer}</p>
          <p class="${q.isCorrect ? "correct" : "wrong"}" 
            style="font-weight:bold; color:${q.isCorrect ? '#4CAF50' : '#f44336'};">
            ${q.isCorrect ? "âœ… Correct" : "âŒ Wrong"}
          </p>
          <div class="ai-feedback" style="background:#f1f1f1; padding:8px; border-radius:5px; margin-top:5px;">
            <em>AI Feedback:</em> ${q.feedback || "No feedback"}
          </div>
        </div>
      `;
    });

    // âœ… Add back button
    // reviewHTML += `<button onclick="toggleLesson(${lessonId})" 
    //                   style="margin-top:15px; padding:8px 12px; border:none; background:#007BFF; color:#fff; border-radius:5px; cursor:pointer;">
    //                   â¬… Back to Lesson</button>`;

    // âœ… Insert into container
    const container =
      document.getElementById(`quiz-review-${lessonId}`) ||
      document.getElementById("lessonMainArea");

    if (container) {
      container.innerHTML = reviewHTML;
    } else {
      console.error("âŒ reviewQuizInline: No container found for lesson " + lessonId);
    }
  }


  async function loadPastQuizzes() {
    try {
      const res = await fetch("/student/quizzes/mine");
      const data = await res.json();
      if (!data.success) {
        alert(data.message || "Could not load quiz submissions");
        return;
      }

      const lessonMain = document.getElementById("lessonMainArea");
      lessonMain.innerHTML = `
        <h2>ğŸ“š My Quiz Submissions</h2>
        <div class="submissions-list">
          ${data.submissions.map(s => `
            <div class="submission-card">
              <h3>${s.lesson_title}</h3>
              <p><strong>Course:</strong> ${s.course_title}</p>
              <p><strong>Module:</strong> ${s.module_title}</p>
              <p><strong>Submitted:</strong> ${new Date(s.created_at).toLocaleString()}</p>
              <p><strong>Score:</strong> ${s.score}%</p>
              <p><strong>Status:</strong> ${s.passed ? "âœ… Passed" : "âŒ Failed"}</p>
              <button onclick="reviewQuizSubmission(${s.id})">ğŸ” Review</button>
            </div>
          `).join("")}
        </div>
      `;
    } catch (err) {
      console.error("Error loading past quizzes:", err);
      alert("Could not load past quizzes");
    }
  }

  async function reviewQuizSubmission(subId) {
    try {
      const res = await fetch(`/student/quizzes/submission/${subId}`);
      const data = await res.json();
      if (!data.success) {
        alert(data.message || "Could not load submission");
        return;
      }

      const s = data.submission;
      const reviewData = s.review_data || [];

      const lessonMain = document.getElementById("lessonMainArea");
      let reviewHTML = `
        <div class="submission-review">
          <h2>ğŸ“ Quiz Review â€“ ${s.lesson_title}</h2>
          <p><strong>Course:</strong> ${s.course_title}</p>
          <p><strong>Module:</strong> ${s.module_title}</p>
          <p><strong>Score:</strong> ${s.score}%</p>
          <p><strong>Status:</strong> ${s.passed ? "âœ… Passed" : "âŒ Failed"}</p>
          <hr>
          <h3>Detailed Review</h3>
      `;

      reviewData.forEach((q, idx) => {
        reviewHTML += `
          <div class="review-question">
            <p><strong>Q${idx + 1}:</strong> ${q.question}</p>
            <p>Your Answer: ${q.yourAnswer || "No answer"}</p>
            <p>Correct Answer: ${q.correctAnswer}</p>
            <p>${q.isCorrect ? "âœ… Correct" : "âŒ Wrong"}</p>
            <p><em>AI Feedback:</em> ${q.feedback || ""}</p>
          </div>
          <hr>
        `;
      });

      reviewHTML += `<button onclick="loadPastQuizzes()">â¬… Back to Quiz List</button></div>`;
      lessonMain.innerHTML = reviewHTML;
    } catch (err) {
      console.error("Error reviewing quiz:", err);
      alert("Could not review quiz submission");
    }
  }

</script>

<!-- Script for AI tutor -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const aiTutor = document.getElementById("ai-tutor");
    const header = aiTutor.querySelector(".ai-tutor-header");

    let isDragging = false;
    let offsetX = 0;
    let offsetY = 0;

    header.addEventListener("mousedown", (e) => {
      isDragging = true;
      offsetX = e.clientX - aiTutor.offsetLeft;
      offsetY = e.clientY - aiTutor.offsetTop;
      aiTutor.style.transition = "none"; // disable smooth snap
      document.body.style.userSelect = "none"; // prevent text selection
    });

    document.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      aiTutor.style.left = e.clientX - offsetX + "px";
      aiTutor.style.top = e.clientY - offsetY + "px";
      aiTutor.style.right = "auto"; // stop sticking to right when moved
      aiTutor.style.bottom = "auto";
      aiTutor.style.position = "fixed";
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
      document.body.style.userSelect = "auto"; // re-enable selection
    });
  });
</script>

